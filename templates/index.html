<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MindMitra</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#d97706">
    <meta name="description" content="A supportive mental health companion for youth">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="MindMitra">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- Icons -->
    <link rel="icon" type="image/png" sizes="32x32" href="/static/icons/icon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/icons/icon-16x16.png">
    <link rel="apple-touch-icon" href="/static/icons/icon-192x192.png">
    
    <!-- Styles -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem;
            text-align: center;
            color: white;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.4);
            border-bottom: 2px solid rgba(217, 119, 6, 0.3);
            position: relative;
        }

        .header h1 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
        }

        .header-logo {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            object-fit: contain;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .header p {
            opacity: 0.9;
            font-size: 0.9rem;
            color: #e2e8f0;
        }

        .streak-header-button {
            position: absolute;
            top: 1rem;
            left: 1rem;
            background: rgba(251, 191, 36, 0.2);
            border: 2px solid #fbbf24;
            color: #fbbf24;
            padding: 0.5rem 1rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
            font-weight: bold;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .streak-header-button:hover {
            background: rgba(251, 191, 36, 0.3);
            border-color: #f59e0b;
            color: #f59e0b;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.3);
        }

        .streak-icon {
            font-size: 1.2rem;
            filter: drop-shadow(0 0 5px rgba(251, 191, 36, 0.5));
        }

        .logout-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(71, 85, 105, 0.8);
            border: 1px solid #475569;
            color: #e2e8f0;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
            backdrop-filter: blur(10px);
        }

        .logout-button:hover {
            background: rgba(100, 116, 139, 0.9);
            border-color: #64748b;
            color: white;
        }

        .safety-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #1e293b;
            border-top: 2px solid #475569;
            padding: 0.75rem 1rem;
            color: #cbd5e1;
            font-size: 0.85rem;
            text-align: center;
            z-index: 1000;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.3);
        }

        .safety-footer strong {
            color: #e2e8f0;
        }

        .main-content {
            display: flex;
            flex: 1;
            gap: 1rem;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            padding: 0 1rem;
            margin-bottom: 50px; /* Space for footer */
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #1e293b;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.4);
            height: calc(100vh - 150px);
            max-height: calc(100vh - 150px);
            border: 1px solid rgba(71, 85, 105, 0.3);
        }

        .hotlines-sidebar {
            width: 300px;
            background: #0f172a;
            border-radius: 20px;
            padding: 1rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            height: fit-content;
            position: sticky;
            top: 1rem;
            border: 1px solid rgba(71, 85, 105, 0.3);
        }

        .sidebar-header h3 {
            color: #64748b;
            margin-bottom: 1rem;
            text-align: center;
            font-size: 1.1rem;
        }

        .hotline-section {
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid #334155;
        }

        .hotline-section:last-child {
            border-bottom: none;
        }

        .hotline-section h4 {
            color: #cbd5e1;
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }

        .hotline-item {
            margin-bottom: 0.5rem;
            padding: 0.4rem;
            background: #1e293b;
            border-radius: 6px;
            border-left: 3px solid #64748b;
        }

        .hotline-item strong {
            color: #f1f5f9;
            display: block;
            margin-bottom: 0.2rem;
            font-size: 0.85rem;
        }

        .hotline-item p {
            color: #94a3b8;
            font-weight: bold;
            margin: 0;
            font-size: 0.8rem;
        }

        .sidebar-footer {
            text-align: center;
            padding-top: 0.75rem;
            border-top: 1px solid #334155;
        }

        .sidebar-footer p {
            color: #94a3b8;
            font-size: 0.8rem;
            margin: 0;
        }

        .messages {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            min-height: 0;
        }

        .message {
            margin-bottom: 1rem;
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background: #d97706;
            color: white;
        }

        .message.assistant .message-avatar {
            background: #fbbf24;
            color: #78350f;
        }

        .message-content {
            background: #fef3c7;
            padding: 0.75rem 1rem;
            border-radius: 18px;
            max-width: 70%;
            word-wrap: break-word;
            line-height: 1.4;
            color: #78350f;
            border: 1px solid #fbbf24;
        }

        .message.user .message-content {
            background: #d97706;
            color: white;
            border: 1px solid #fbbf24;
        }

        .message.crisis .message-content {
            background: #fef2f2;
            border: 2px solid #dc2626;
            color: #991b1b;
        }

        .message.safety .message-content {
            background: #eff6ff;
            border: 2px solid #2563eb;
            color: #1e40af;
        }

        .input-container {
            padding: 1rem;
            background: #334155;
            border-radius: 0 0 20px 20px;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.4);
            border-top: 1px solid rgba(71, 85, 105, 0.3);
        }

        .input-group {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .message-input {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 2px solid #fbbf24;
            border-radius: 25px;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.2s;
            background: white;
            color: #78350f;
        }

        .message-input:focus {
            border-color: #d97706;
        }

        .message-input::placeholder {
            color: #a3a3a3;
        }

        .send-button {
            background: #d97706;
            color: white;
            border: none;
            padding: 0.75rem 1rem;
            border-radius: 50%;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 50px;
            height: 50px;
        }

        .send-button:hover {
            background: #b45309;
        }

        .send-button:disabled {
            background: #64748b;
            cursor: not-allowed;
        }

        .typing-indicator {
            display: none;
            padding: 0.75rem 1rem;
            color: #cbd5e1;
            font-style: italic;
        }

        .crisis-resources {
            background: #fef2f2;
            border: 2px solid #dc2626;
            margin: 1rem;
            padding: 1rem;
            border-radius: 12px;
            color: #991b1b;
        }

        .crisis-resources h3 {
            color: #dc2626;
            margin-bottom: 0.5rem;
        }

        .crisis-resources a {
            color: #dc2626;
            text-decoration: none;
            font-weight: bold;
        }

        .crisis-resources a:hover {
            text-decoration: underline;
        }

        /* Hamburger Menu Button for Mobile */
        .hamburger-button {
            display: none;
            position: absolute;
            top: 3.5rem;
            right: 1rem;
            background: rgba(217, 119, 6, 0.9);
            color: white;
            border: 1px solid #fbbf24;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            cursor: pointer;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            font-size: 1.5rem;
            transition: all 0.2s ease;
            line-height: 1;
            backdrop-filter: blur(10px);
        }

        .hamburger-button:hover {
            background: rgba(180, 83, 9, 0.95);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.3);
        }

        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            backdrop-filter: blur(2px);
        }

        .sidebar-overlay.active {
            display: block;
        }

        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
                padding: 0;
            }

            .chat-container {
                border-radius: 0;
                margin: 0;
                min-height: 100%;
                height: calc(100vh - 150px);
                width: 100%;
                padding-bottom: 0;
            }

            .messages {
                padding-bottom: 90px;
            }

            .input-container {
                position: fixed;
                bottom: 50px;
                left: 0;
                right: 0;
                border-radius: 0;
                background: #334155;
                z-index: 100;
                margin: 0;
            }

            .safety-footer {
                position: fixed;
                bottom: 0;
                z-index: 99;
            }

            .message-content {
                max-width: 85%;
            }

            .header h1 {
                font-size: 1.2rem;
            }

            .header p {
                font-size: 0.8rem;
            }

            .streak-header-button {
                padding: 0.4rem 0.75rem;
                font-size: 0.85rem;
            }

            .logout-button {
                padding: 0.4rem 0.75rem;
                font-size: 0.85rem;
            }

            /* Sliding sidebar for mobile */
            .hotlines-sidebar {
                position: fixed;
                top: 0;
                right: -100%;
                width: 85%;
                max-width: 350px;
                height: 100vh;
                background: #0f172a;
                border-radius: 0;
                margin: 0;
                padding: 1rem;
                z-index: 2500;
                transition: right 0.3s ease;
                overflow-y: auto;
                box-shadow: -4px 0 20px rgba(0, 0, 0, 0.5);
            }

            .hotlines-sidebar.active {
                right: 0;
            }

            .sidebar-close-button {
                position: absolute;
                top: 1rem;
                right: 1rem;
                background: rgba(71, 85, 105, 0.8);
                border: none;
                color: #cbd5e1;
                width: 32px;
                height: 32px;
                border-radius: 50%;
                cursor: pointer;
                font-size: 1.2rem;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .hamburger-button {
                display: flex;
                align-items: center;
                justify-content: center;
                top: 3.5rem;
                right: 1rem;
                width: 36px;
                height: 36px;
                font-size: 1.3rem;
            }

            .streak-container {
                padding: 1.5rem;
            }

            .streak-flame {
                font-size: 3rem;
            }

            .streak-count {
                font-size: 2rem;
            }

            .day-circle {
                width: 40px;
                height: 40px;
                font-size: 2rem;
            }

            .day-label {
                font-size: 0.65rem;
            }

            .hotlines-sidebar .hotline-section {
                display: block;
                width: 100%;
                margin-right: 0;
            }

            .safety-footer {
                font-size: 0.75rem;
                padding: 0.5rem;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1rem;
            }

            .header p {
                display: none;
            }

            .header-logo {
                width: 35px;
                height: 35px;
            }

            .streak-header-button {
                padding: 0.3rem 0.6rem;
                font-size: 0.8rem;
                top: 0.75rem;
                left: 0.75rem;
            }

            .streak-icon {
                font-size: 1rem;
            }

            .logout-button {
                padding: 0.3rem 0.6rem;
                font-size: 0.8rem;
                top: 0.75rem;
                right: 0.75rem;
            }

            .hotlines-sidebar .hotline-section {
                width: 100%;
                margin-right: 0;
            }

            .hamburger-button {
                width: 32px;
                height: 32px;
                font-size: 1.2rem;
                top: 2.75rem;
                right: 0.75rem;
            }

            .streak-container {
                padding: 1rem;
            }

            .streak-flame {
                font-size: 2.5rem;
            }

            .streak-count {
                font-size: 1.75rem;
            }

            .streak-label {
                font-size: 0.8rem;
            }

            .streak-message {
                font-size: 0.75rem;
            }

            .day-circle {
                width: 32px;
                height: 32px;
                font-size: 1.6rem;
            }

            .weekly-calendar {
                gap: 0.15rem;
            }

            .calendar-day {
                flex: 0 0 auto;
                min-width: 32px;
            }

            .day-label {
                font-size: 0.6rem;
                margin-bottom: 0.3rem;
            }

            .streak-container {
                padding: 1.25rem;
                max-width: 95vw;
            }
        }

        /* Install prompt */
        .install-prompt {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #1e293b;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 25px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 1000;
            border: 1px solid #475569;
        }

        .install-prompt button {
            background: #475569;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            margin-left: 1rem;
            cursor: pointer;
            font-weight: bold;
        }

        .install-prompt button:hover {
            background: #64748b;
        }

        /* Streak Modal Styles */
        .streak-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            backdrop-filter: blur(4px);
        }

        .streak-modal-overlay.active {
            display: flex;
        }

        .streak-container {
            background: #0f172a;
            border-radius: 20px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
            border: 2px solid rgba(251, 191, 36, 0.3);
            position: relative;
        }

        .streak-close-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(71, 85, 105, 0.8);
            border: none;
            color: #cbd5e1;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .streak-close-button:hover {
            background: rgba(100, 116, 139, 0.9);
            color: white;
        }

        .streak-header {
            text-align: center;
            margin-bottom: 1rem;
        }

        .streak-flame {
            font-size: 4rem;
            margin-bottom: 0.5rem;
            filter: drop-shadow(0 0 10px rgba(251, 191, 36, 0.5));
        }

        .streak-count {
            font-size: 2.5rem;
            font-weight: bold;
            color: #fbbf24;
            margin-bottom: 0.25rem;
        }

        .streak-label {
            color: #cbd5e1;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .streak-message {
            text-align: center;
            color: #94a3b8;
            font-size: 0.85rem;
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: rgba(251, 191, 36, 0.1);
            border-radius: 8px;
        }

        .weekly-calendar {
            display: flex;
            justify-content: space-between;
            gap: 0.5rem;
            margin-top: 1.5rem;
        }

        .calendar-day {
            flex: 1;
            text-align: center;
        }

        .day-label {
            color: #64748b;
            font-size: 0.7rem;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
        }

        .day-circle {
            width: 50px;
            height: 50px;
            margin: 0 auto;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            position: relative;
            font-size: 2.5rem;
            transition: all 0.3s ease;
        }

        .day-circle.active::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 80%;
            background-image: url('/static/hot_chai.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            filter: drop-shadow(0 0 8px rgba(251, 191, 36, 0.6));
            animation: steam 2s ease-in-out infinite;
        }

        @keyframes steam {
            0%, 100% { transform: translate(-50%, -50%) translateY(0px); }
            50% { transform: translate(-50%, -50%) translateY(-2px); }
        }

        .day-circle.frozen::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 80%;
            background-image: url('/static/cold_chai.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            filter: drop-shadow(0 0 10px rgba(147, 197, 253, 0.8));
        }

        .day-circle.today {
            transform: scale(1.15);
            background: rgba(96, 165, 250, 0.15);
            border-radius: 50%;
        }

        .freeze-button:hover:not(:disabled) {
            transform: scale(1.1);
            background: rgba(59, 130, 246, 0.3);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .freeze-button:active:not(:disabled) {
            transform: scale(1.05);
        }

        .freeze-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .day-circle.inactive::after {
            content: 'ü´ñ';
            opacity: 0.3;
            filter: grayscale(100%);
        }

        .day-circle.missed::after {
            content: '‚úñ';
            opacity: 0.5;
            color: #64748b;
            font-size: 1.8rem;
        }

        /* Feelings Thermometer Styles */
        .feelings-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .feelings-modal {
            background: #1e293b;
            border: 2px solid #475569;
            border-radius: 20px;
            padding: 2rem;
            max-width: 400px;
            width: 90%;
            text-align: center;
            color: white;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
        }

        .feelings-modal h2 {
            color: #fbbf24;
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }

        .feelings-modal p {
            color: #cbd5e1;
            margin-bottom: 2rem;
            line-height: 1.5;
        }

        .thermometer-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 2rem 0;
            gap: 0.5rem;
        }

        .thermometer-number {
            background: #334155;
            border: 2px solid #475569;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #cbd5e1;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .thermometer-number:hover {
            transform: scale(1.1);
            border-color: #fbbf24;
        }

        .thermometer-number.selected {
            background: #d97706;
            border-color: #fbbf24;
            color: white;
            transform: scale(1.1);
        }

        .feelings-scale {
            display: flex;
            justify-content: space-between;
            margin: 1rem 0;
            font-size: 0.8rem;
            color: #94a3b8;
        }

        .feelings-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .feelings-button {
            flex: 1;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s ease;
        }

        .feelings-submit {
            background: #d97706;
            color: white;
        }

        .feelings-submit:hover:not(:disabled) {
            background: #b45309;
        }

        .feelings-submit:disabled {
            background: #64748b;
            cursor: not-allowed;
        }

        .feelings-skip {
            background: #475569;
            color: #cbd5e1;
        }

        .feelings-skip:hover {
            background: #64748b;
            color: white;
        }

        @media (max-width: 480px) {
            .thermometer-number {
                width: 30px;
                height: 30px;
                font-size: 0.8rem;
            }

            .feelings-modal {
                padding: 1.5rem;
            }
        }

        /* Extra small phones */
        @media (max-width: 380px) {
            .day-circle {
                width: 28px;
                height: 28px;
                font-size: 1.4rem;
            }

            .weekly-calendar {
                gap: 0.1rem;
            }

            .calendar-day {
                min-width: 28px;
            }

            .day-label {
                font-size: 0.55rem;
            }

            .streak-container {
                padding: 1rem;
            }

            .streak-flame {
                font-size: 2rem;
            }

            .streak-count {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
            <div class="header">
            <button class="streak-header-button" id="streakHeaderButton" onclick="openStreakModal()">
                <span class="streak-icon">üî•</span>
                <span id="headerStreakCount">0</span>
            </button>
            <h1>
                <img src="/logo.jpeg" alt="MindMitra Logo" class="header-logo">
                MindMitra
            </h1>
            <p>Your mental health companion and guide</p>
            <button class="logout-button" onclick="logout()">Logout</button>
            <button class="hamburger-button" id="hamburgerButton" onclick="toggleHelplines()">‚ò∞</button>
        </div>

    <div class="main-content">
        <div class="chat-container">
            <div class="messages" id="messages">
                <!-- Messages will be loaded from database -->
            </div>

            <div class="typing-indicator" id="typing">
                <i class="fas fa-circle"></i> Bot is typing...
            </div>

            <div class="input-container">
                <div class="input-group">
                    <input type="text" class="message-input" id="messageInput" placeholder="How are you feeling today?" maxlength="500">
                    <button class="send-button" id="sendButton" onclick="sendMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>

        <div class="hotlines-sidebar" id="hotlinesSidebar">
            <button class="sidebar-close-button" onclick="toggleHelplines()">√ó</button>
            <div class="sidebar-header">
                <h3>üìû Emergency Helplines</h3>
            </div>
            
            <div class="hotline-section">
                <h4>üö® Crisis Support</h4>
                <div class="hotline-item">
                    <strong>AASRA</strong>
                    <p>022 2754 6669</p>
                </div>
                <div class="hotline-item">
                    <strong>Kiran Helpline</strong>
                    <p>1800-599-0019</p>
                </div>
                <div class="hotline-item">
                    <strong>Tele Manas</strong>
                    <p>1800-891-4416</p>
                </div>
            </div>

            <div class="hotline-section">
                <h4>üÜò Emergency Services</h4>
                <div class="hotline-item">
                    <strong>Police</strong>
                    <p>100</p>
                </div>
                <div class="hotline-item">
                    <strong>Ambulance</strong>
                    <p>102</p>
                </div>
                <div class="hotline-item">
                    <strong>Emergency</strong>
                    <p>112</p>
                </div>
                <div class="sidebar-footer">
                    <p><strong>üíõ You're not alone. Help is available 24/7.</strong></p>
                </div>
            </div>
            
        </div>
    </div>

    <!-- Sidebar overlay for mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleHelplines()"></div>

    <div class="install-prompt" id="installPrompt">
        <span>Install this app for a better experience</span>
        <button onclick="installApp()">Install</button>
    </div>

    <!-- Safety Footer -->
    <div class="safety-footer">
        ‚ö†Ô∏è <strong>Important Notice</strong>: This is a non-clinical support tool for general mental wellness. If you're experiencing a crisis, please refer to the emergency helplines.
    </div>

    <!-- Streak Modal -->
    <div class="streak-modal-overlay" id="streakModal">
        <div class="streak-container" id="streakContainer">
            <button class="streak-close-button" onclick="closeStreakModal()">√ó</button>
            <div class="streak-header">
                <div class="streak-flame">üî•</div>
                <div class="streak-count" id="streakCount">0</div>
                <div class="streak-label">day streak</div>
            </div>
            <div class="streak-message" id="streakMessage">
                Send a message today to keep your streak alive!
            </div>
            <div style="text-align: center; margin-top: 0.5rem; padding: 0.5rem; background: rgba(251, 191, 36, 0.05); border-radius: 6px; color: #94a3b8; font-size: 0.75rem;">
                üí¨ Send <strong style="color: #fbbf24;">5+ messages</strong> per day to count toward your streak
            </div>
            <div class="weekly-calendar" id="weeklyCalendar">
                <!-- Calendar days will be generated by JavaScript -->
            </div>
            <div class="freeze-section" style="margin-top: 1rem; text-align: center;">
                <button id="useFreezeButton" class="freeze-button" onclick="useFreezeToday()" title="Use a freeze to protect your streak for today" style="padding: 0.5rem; background: rgba(59, 130, 246, 0.2); color: #60a5fa; border: 1px solid #3b82f6; border-radius: 50%; font-size: 1.5rem; cursor: pointer; transition: all 0.2s ease; width: 40px; height: 40px; display: inline-flex; align-items: center; justify-content: center;">
                    ‚ùÑÔ∏è
                </button>
                <div class="freeze-info" id="freezeInfo" style="margin-top: 0.5rem; color: #94a3b8; font-size: 0.75rem;">
                    <span id="freezeStatusText"><strong id="freezesAvailable">1</strong> freeze left this week</span>
                </div>
                <div id="freezeMessage" style="margin-top: 0.5rem; padding: 0.5rem; border-radius: 8px; font-size: 0.75rem; display: none;"></div>
            </div>
        </div>
    </div>

    <!-- Feelings Thermometer Modal -->
    <div class="feelings-overlay" id="feelingsOverlay">
        <div class="feelings-modal">
            <h2>üå°Ô∏è Daily Check-In</h2>
            <p>How are you feeling today? Rate your overall mood on a scale of 0-10.</p>

            <div class="thermometer-container" id="thermometerContainer">
                <!-- Numbers 0-10 will be generated by JavaScript -->
            </div>

            <div class="feelings-scale">
                <span>üòû Very Low</span>
                <span>üòê Neutral</span>
                <span>üòä Great</span>
            </div>

            <div class="feelings-buttons">
                <button class="feelings-button feelings-skip" onclick="skipFeelingsCheck()">Skip Today</button>
                <button class="feelings-button feelings-submit" id="submitFeeling" onclick="submitFeeling()" disabled>Submit</button>
            </div>
        </div>
    </div>

    <script>
        let deferredPrompt;
        let userId = null;
        let selectedFeeling = null;
        
        // Load chat history from server
        async function loadChatHistory() {
            if (!userId) {
                console.log('DEBUG: No userId set, cannot load chat history');
                return;
            }

            console.log(`DEBUG: Loading chat history for user: ${userId}`);

            try {
                const response = await fetch(`/api/session/${userId}`);
                console.log(`DEBUG: API response status: ${response.status}`);

                const data = await response.json();
                console.log(`DEBUG: API response data:`, data);

                const messagesContainer = document.getElementById('messages');

                if (data.messages && data.messages.length > 0) {
                    console.log(`DEBUG: Found ${data.messages.length} previous messages`);

                    // Add all previous messages
                    data.messages.forEach((msg, index) => {
                        console.log(`DEBUG: Adding message ${index + 1}: ${msg.role} - ${msg.content.substring(0, 50)}...`);
                        addMessage(msg.content, msg.role);
                    });

                    console.log(`‚úÖ Successfully loaded ${data.messages.length} previous messages`);
                } else {
                    console.log('DEBUG: No previous messages found, adding initial greeting');
                    // First time user - add initial greeting and save it to database
                    const greeting = "Hi there! I'm here to listen and support you. How are you feeling today?";
                    addMessage(greeting, 'assistant');

                    // Save initial greeting to database
                    try {
                        await fetch('/api/chat/init', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                user_id: userId,
                                message: greeting
                            })
                        });
                        console.log('DEBUG: Initial greeting saved to database');
                    } catch (error) {
                        console.error('Error saving initial greeting:', error);
                    }
                }
            } catch (error) {
                console.error('‚ùå Error loading chat history:', error);
            }
        }

        // Check authentication on page load
        function checkAuth() {
            const loginId = localStorage.getItem('mindmitra_login_id');
            console.log(`DEBUG: Checking auth, loginId from localStorage: ${loginId}`);

            if (!loginId) {
                console.log('DEBUG: No loginId found, redirecting to login');
                // Redirect to login if not authenticated
                window.location.href = '/login';
                return;
            }

            // Validate session with server
            fetch('/api/auth/validate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ login_id: loginId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.valid) {
                    // Check if user needs to consent
                    if (data.needs_consent) {
                        console.log('DEBUG: User needs to consent, redirecting to consent page');
                        window.location.href = '/consent';
                        return;
                    }
                    
                    userId = loginId;
                    console.log(`DEBUG: Authentication successful, userId set to: ${userId}`);

                    // Load user info
                    if (data.user) {
                        console.log('Logged in as:', data.user.login_id);
                        console.log('Access code:', data.user.access_code);
                    }
                    // Load chat history after successful authentication
                    console.log('DEBUG: About to load chat history...');
                    loadChatHistory();
                    // Check feelings status after authentication
                    checkFeelingsStatus();
                    // Load streak data
                    loadStreakData();
                } else {
                    // Clear invalid session and redirect to login
                    localStorage.removeItem('mindmitra_login_id');
                    localStorage.removeItem('mindmitra_user_type');
                    window.location.href = '/login';
                }
            })
            .catch(error => {
                console.error('Auth validation error:', error);
                localStorage.removeItem('mindmitra_login_id');
                localStorage.removeItem('mindmitra_user_type');
                window.location.href = '/login';
            });
        }
        
        // Logout function
        function logout() {
            const loginId = localStorage.getItem('mindmitra_login_id');
            if (loginId) {
                fetch('/api/auth/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ login_id: loginId })
                }).catch(error => console.error('Logout error:', error));
            }
            
            localStorage.removeItem('mindmitra_login_id');
            localStorage.removeItem('mindmitra_user_type');
            window.location.href = '/login';
        }

        // PWA Install Prompt
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installPrompt').style.display = 'block';
        });

        async function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    console.log('User accepted the install prompt');
                }
                deferredPrompt = null;
                document.getElementById('installPrompt').style.display = 'none';
            }
        }

        // Chat functionality
        const messagesContainer = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const typingIndicator = document.getElementById('typing');

        function addMessage(content, role, type = 'normal') {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role} ${type}`;
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = role === 'user' ? 'üë§' : 'ü§ñ';
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            messageContent.innerHTML = content;
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageContent);
            messagesContainer.appendChild(messageDiv);
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showTyping() {
            typingIndicator.style.display = 'block';
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function hideTyping() {
            typingIndicator.style.display = 'none';
        }

        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            // Add user message
            addMessage(message, 'user');
            messageInput.value = '';
            sendButton.disabled = true;

            // Show typing indicator
            showTyping();

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: userId,
                        message: message
                    })
                });

                const data = await response.json();

                if (data.error) {
                    addMessage(`Error: ${data.error}`, 'assistant', 'error');
                } else if (data.restricted) {
                    // User has been restricted - log them out
                    addMessage(data.response, 'assistant', 'error');
                    setTimeout(() => {
                        alert('Your access has been restricted due to multiple safety concerns. You will be logged out.');
                        logout();
                    }, 2000);
                } else {
                    // Add bot response
                    addMessage(data.response, 'assistant', data.type);

                    // Update streak after successful message
                    loadStreakData();
                }
            } catch (error) {
                addMessage('Sorry, something went wrong. Please try again.', 'assistant', 'error');
            } finally {
                hideTyping();
                sendButton.disabled = false;
                messageInput.focus();
            }
        }

        function showCrisisResources() {
            const resourcesDiv = document.createElement('div');
            resourcesDiv.className = 'crisis-resources';
            resourcesDiv.innerHTML = `
                <h3>üö® Crisis Support Available</h3>
                <p><strong>AASRA Helpline:</strong> 022 2754 6669</p>
                <p><strong>National Crisis Helpline:</strong> 1800-599-0019</p>
                <p><strong>Emergency Services:</strong> 112</p>
                <p><strong>Police:</strong> 100</p>
            `;
            messagesContainer.appendChild(resourcesDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Enter key to send
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Focus input on load
        messageInput.focus();
        
        // Feelings Thermometer Functions
        function initFeelingsThermometer() {
            const container = document.getElementById('thermometerContainer');
            container.innerHTML = '';

            // Create numbers 0-10
            for (let i = 0; i <= 10; i++) {
                const numberDiv = document.createElement('div');
                numberDiv.className = 'thermometer-number';
                numberDiv.textContent = i;
                numberDiv.onclick = () => selectFeeling(i);
                container.appendChild(numberDiv);
            }
        }

        function selectFeeling(score) {
            selectedFeeling = score;

            // Remove previous selection
            document.querySelectorAll('.thermometer-number').forEach(num => {
                num.classList.remove('selected');
            });

            // Add selection to clicked number
            document.querySelectorAll('.thermometer-number')[score].classList.add('selected');

            // Enable submit button
            document.getElementById('submitFeeling').disabled = false;
        }

        async function checkFeelingsStatus() {
            if (!userId) return;

            try {
                const response = await fetch('/api/feelings/check', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ user_id: userId })
                });

                const data = await response.json();

                // If user hasn't recorded feeling today, show the thermometer
                if (!data.recorded_today) {
                    setTimeout(() => {
                        document.getElementById('feelingsOverlay').style.display = 'flex';
                    }, 2000); // Show after 2 seconds
                }

            } catch (error) {
                console.error('Error checking feelings status:', error);
            }
        }

        async function submitFeeling() {
            if (selectedFeeling === null) return;

            try {
                const submitButton = document.getElementById('submitFeeling');
                submitButton.disabled = true;
                submitButton.textContent = 'Submitting...';

                const response = await fetch('/api/feelings/record', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: userId,
                        feeling_score: selectedFeeling
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // Show success message briefly
                    document.querySelector('.feelings-modal h2').textContent = '‚úÖ Thank you!';
                    document.querySelector('.feelings-modal p').textContent = `Your feeling score of ${selectedFeeling}/10 has been recorded for today.`;
                    document.querySelector('.feelings-buttons').style.display = 'none';
                    document.getElementById('thermometerContainer').style.display = 'none';
                    document.querySelector('.feelings-scale').style.display = 'none';

                    // Hide modal after 2 seconds
                    setTimeout(() => {
                        document.getElementById('feelingsOverlay').style.display = 'none';
                    }, 2000);
                } else {
                    alert('Error recording feeling: ' + (data.error || 'Unknown error'));
                    submitButton.disabled = false;
                    submitButton.textContent = 'Submit';
                }

            } catch (error) {
                console.error('Error submitting feeling:', error);
                alert('Error submitting feeling. Please try again.');
                document.getElementById('submitFeeling').disabled = false;
                document.getElementById('submitFeeling').textContent = 'Submit';
            }
        }

        function skipFeelingsCheck() {
            document.getElementById('feelingsOverlay').style.display = 'none';

            // Store that user skipped today (optional - could use localStorage)
            localStorage.setItem('mindmitra_feelings_skipped_' + new Date().toDateString(), 'true');
        }

        // Streak Functions
        async function loadStreakData() {
            if (!userId) {
                console.log('No userId, skipping streak load');
                return;
            }

            console.log('Loading streak data for user:', userId);

            try {
                const response = await fetch(`/api/streak/${userId}`);
                const data = await response.json();
                
                console.log('Streak API Response:', data);

                if (data.success && data.streak_data) {
                    console.log('Rendering streak with data:', data.streak_data);
                    renderStreak(data.streak_data);
                } else {
                    console.error('No streak data in response:', data);
                }
            } catch (error) {
                console.error('Error loading streak data:', error);
            }
        }

        function renderStreak(streakData) {
            const streakCount = document.getElementById('streakCount');
            const headerStreakCount = document.getElementById('headerStreakCount');
            const streakMessage = document.getElementById('streakMessage');

            // Update streak counts
            const currentStreak = streakData.current_streak || 0;
            streakCount.textContent = currentStreak;
            headerStreakCount.textContent = currentStreak;

            // Update streak message
            if (streakData.has_activity_today) {
                if (streakData.current_streak > 0) {
                    streakMessage.innerHTML = `üéâ Amazing! You've kept your streak going for <strong>${streakData.current_streak}</strong> day${streakData.current_streak !== 1 ? 's' : ''}!`;
                } else {
                    streakMessage.textContent = 'Great job staying connected today!';
                }
            } else {
                if (streakData.current_streak > 0) {
                    streakMessage.innerHTML = `üî• You're on a <strong>${streakData.current_streak}</strong> day streak! Send a message today to keep it going!`;
                } else {
                    streakMessage.textContent = 'Send a message today to start your streak!';
                }
            }

            // Render weekly calendar
            renderWeeklyCalendar(streakData.weekly_activity, streakData.frozen_days);
            
            // Load and display freeze status
            loadFreezeStatus();
        }

        function renderWeeklyCalendar(weeklyActivity, frozenDays) {
            const calendar = document.getElementById('weeklyCalendar');
            calendar.innerHTML = '';

            const days = ['Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa', 'Su'];
            
            // Use local date without timezone conversion
            const today = new Date();
            const todayStr = formatDateLocal(today);
            
            // Get current week from Monday to Sunday
            const currentDay = today.getDay(); // 0 = Sunday, 1 = Monday, etc.
            const daysFromMonday = currentDay === 0 ? 6 : currentDay - 1; // Days since Monday
            
            // Calculate Monday of current week
            const monday = new Date(today);
            monday.setDate(today.getDate() - daysFromMonday);
            
            // Generate 7 days starting from Monday
            const dates = [];
            for (let i = 0; i < 7; i++) {
                const date = new Date(monday);
                date.setDate(monday.getDate() + i);
                dates.push(date);
            }

            console.log('Weekly Activity Data:', weeklyActivity);
            console.log('Frozen Days Data:', frozenDays);
            console.log('Today local date:', todayStr);
            
            dates.forEach((date, index) => {
                const dateStr = formatDateLocal(date);
                const dayOfWeek = days[index];
                const isToday = dateStr === todayStr;
                const hasActivity = weeklyActivity && weeklyActivity[dateStr] === true;
                const isFrozen = frozenDays && frozenDays[dateStr] === true;
                const isFutureDate = date > today;
                const isPastDate = date < today;

                console.log(`Day ${dayOfWeek} (${dateStr}): isToday=${isToday}, hasActivity=${hasActivity}, isFrozen=${isFrozen}, isPast=${isPastDate}`);

                const dayDiv = document.createElement('div');
                dayDiv.className = 'calendar-day';
                
                const label = document.createElement('div');
                label.className = 'day-label';
                label.textContent = dayOfWeek;
                
                const circle = document.createElement('div');
                circle.className = 'day-circle';
                
                // Priority: frozen > active > missed (past + no activity) > inactive (future or today)
                if (isFrozen) {
                    circle.classList.add('frozen');
                } else if (hasActivity) {
                    circle.classList.add('active');
                } else if (isPastDate) {
                    // Past date with no activity = missed
                    circle.classList.add('missed');
                } else {
                    // Future date or today with no activity yet = inactive
                    circle.classList.add('inactive');
                }
                
                if (isToday) {
                    circle.classList.add('today');
                }
                
                dayDiv.appendChild(label);
                dayDiv.appendChild(circle);
                calendar.appendChild(dayDiv);
            });
        }

        // Helper function to format date as YYYY-MM-DD in local timezone
        function formatDateLocal(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        async function loadFreezeStatus() {
            if (!userId) return;

            try {
                const response = await fetch(`/api/streak/freeze-status/${userId}`);
                const data = await response.json();

                if (data.success && data.freeze_status) {
                    const status = data.freeze_status;
                    const freezesAvailableEl = document.getElementById('freezesAvailable');
                    const freezeStatusText = document.getElementById('freezeStatusText');
                    const freezeButton = document.getElementById('useFreezeButton');

                    if (freezesAvailableEl) {
                        freezesAvailableEl.textContent = status.freezes_available;
                    }

                    // Update button state
                    if (freezeButton) {
                        if (status.freezes_available === 0) {
                            freezeButton.disabled = true;
                            freezeButton.style.opacity = '0.5';
                            freezeButton.style.cursor = 'not-allowed';
                        } else {
                            freezeButton.disabled = false;
                            freezeButton.style.opacity = '1';
                            freezeButton.style.cursor = 'pointer';
                        }
                    }

                    if (status.freezes_available === 0) {
                        freezeStatusText.innerHTML = 'No freezes (resets Monday)';
                    } else {
                        freezeStatusText.innerHTML = `<strong>${status.freezes_available}</strong> freeze left this week`;
                    }
                }
            } catch (error) {
                console.error('Error loading freeze status:', error);
            }
        }

        async function useFreezeToday() {
            if (!userId) return;

            const freezeButton = document.getElementById('useFreezeButton');
            const freezeMessage = document.getElementById('freezeMessage');
            
            // Disable button during request
            freezeButton.disabled = true;
            freezeMessage.style.display = 'none';

            // Determine which day to freeze (yesterday if no activity today, otherwise today)
            const today = new Date();
            const todayStr = formatDateLocal(today);
            
            try {
                const response = await fetch('/api/streak/freeze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: userId,
                        freeze_date: todayStr
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // Show success message
                    freezeMessage.innerHTML = '‚úÖ Streak frozen successfully!';
                    freezeMessage.style.background = 'rgba(34, 197, 94, 0.2)';
                    freezeMessage.style.color = '#86efac';
                    freezeMessage.style.display = 'block';
                    
                    // Reload streak data to show updated calendar
                    setTimeout(() => {
                        loadStreakData();
                        freezeMessage.style.display = 'none';
                    }, 2000);
                } else {
                    // Show error message
                    freezeMessage.innerHTML = `‚ùå ${data.error || 'Failed to freeze streak'}`;
                    freezeMessage.style.background = 'rgba(239, 68, 68, 0.2)';
                    freezeMessage.style.color = '#fca5a5';
                    freezeMessage.style.display = 'block';
                    
                    // Re-enable button
                    freezeButton.disabled = false;
                    
                    // Hide error after 3 seconds
                    setTimeout(() => {
                        freezeMessage.style.display = 'none';
                    }, 3000);
                }
            } catch (error) {
                console.error('Error freezing streak:', error);
                freezeMessage.innerHTML = '‚ùå Error freezing streak. Please try again.';
                freezeMessage.style.background = 'rgba(239, 68, 68, 0.2)';
                freezeMessage.style.color = '#fca5a5';
                freezeMessage.style.display = 'block';
                freezeButton.disabled = false;
                
                setTimeout(() => {
                    freezeMessage.style.display = 'none';
                }, 3000);
            }
        }

        function openStreakModal() {
            document.getElementById('streakModal').classList.add('active');
        }

        function closeStreakModal() {
            document.getElementById('streakModal').classList.remove('active');
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('streakModal');
            if (event.target === modal) {
                closeStreakModal();
            }
        });

        // Toggle helplines sidebar for mobile
        function toggleHelplines() {
            const sidebar = document.getElementById('hotlinesSidebar');
            const overlay = document.getElementById('sidebarOverlay');

            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');

            // Prevent body scrolling when sidebar is open
            if (sidebar.classList.contains('active')) {
                document.body.style.overflow = 'hidden';
            } else {
                document.body.style.overflow = '';
            }
        }

        // Initialize feelings thermometer on page load
        initFeelingsThermometer();

        // Check authentication on page load
        checkAuth();

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('SW registered: ', registration);
                    })
                    .catch((registrationError) => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
    </script>
</body>
</html> 