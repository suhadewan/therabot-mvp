<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MindMitra</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#d97706">
    <meta name="description" content="A supportive mental health companion for youth">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="MindMitra">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- Icons -->
    <link rel="icon" type="image/png" sizes="32x32" href="/static/icons/icon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/icons/icon-16x16.png">
    <link rel="apple-touch-icon" href="/static/icons/icon-192x192.png">
    
    <!-- Styles -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Theme Variables - Light Mode (default) - Blue Serenity palette */
        :root {
            --background: #e8ecf4;
            --background-secondary: #dce3ef;
            --chat-area-bg: #f4f6fb;
            --foreground: #2d3748;
            --card: #f4f6fb;
            --card-foreground: #2d3748;
            --primary: #5c73b9;
            --primary-foreground: #ffffff;
            --secondary: #e0e7f2;
            --secondary-foreground: #2d3748;
            --muted: #dce3ef;
            --muted-foreground: #64748b;
            --accent: #d4dce8;
            --accent-foreground: #2d3748;
            --border: #c8d4e8;
            --input: #dce3ef;
            --destructive: #ef4444;
            --shadow-color: rgba(92, 115, 185, 0.1);
            --shadow-heavy: rgba(92, 115, 185, 0.15);
            --message-bot-bg: linear-gradient(135deg, #5c73b9 0%, #7c3aed 100%);
            --message-bot-text: #ffffff;
            --message-user-bg: #ffffff;
            --message-user-text: #2d3748;
            --message-user-border: #c8d4e8;
            --header-bg: rgba(244, 246, 251, 0.95);
            --input-bg: #ffffff;
            --input-text: #2d3748;
        }

        /* Dark Mode */
        .dark {
            --background: #0a0a0a;
            --background-secondary: #141414;
            --chat-area-bg: #1a1a2e;
            --foreground: #f5f5f5;
            --card: #141414;
            --card-foreground: #f5f5f5;
            --primary: #5c73b9;
            --primary-foreground: #ffffff;
            --secondary: #1a1a1a;
            --secondary-foreground: #f5f5f5;
            --muted: #1a1a1a;
            --muted-foreground: #a3a3a3;
            --accent: #1f1f1f;
            --accent-foreground: #f5f5f5;
            --border: #262626;
            --input: #1a1a1a;
            --destructive: #ef4444;
            --shadow-color: rgba(0, 0, 0, 0.4);
            --shadow-heavy: rgba(0, 0, 0, 0.6);
            --message-bot-bg: linear-gradient(135deg, #5c73b9 0%, #7c3aed 100%);
            --message-bot-text: #ffffff;
            --message-user-bg: #1a1a1a;
            --message-user-text: #f5f5f5;
            --message-user-border: #262626;
            --header-bg: rgba(20, 20, 20, 0.95);
            --input-bg: #1a1a1a;
            --input-text: #f5f5f5;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--background);
            color: var(--foreground);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .header {
            background: var(--header-bg);
            backdrop-filter: blur(10px);
            padding: 1rem;
            text-align: center;
            color: var(--foreground);
            box-shadow: 0 2px 20px var(--shadow-color);
            border-bottom: 1px solid var(--border);
            position: relative;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .header h1 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
        }

        .header-logo {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            object-fit: contain;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .header p {
            opacity: 0.9;
            font-size: 0.9rem;
            color: var(--muted-foreground);
        }

        /* Theme Toggle Button */
        .theme-toggle {
            position: absolute;
            top: 1rem;
            right: 6rem;
            background: var(--secondary);
            border: 1px solid var(--border);
            color: var(--foreground);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            background: var(--accent);
            transform: scale(1.05);
        }

        .feature-buttons-container {
            position: absolute;
            top: 1rem;
            left: 1rem;
            display: flex;
            gap: 0.5rem;
            align-items: center;
            z-index: 10;
        }

        .streak-header-button {
            position: relative;
            top: auto;
            left: auto;
            background: rgba(251, 191, 36, 0.2);
            border: 2px solid #fbbf24;
            color: #fbbf24;
            padding: 0.5rem 1rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
            font-weight: bold;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .streak-header-button:hover {
            background: rgba(251, 191, 36, 0.3);
            border-color: #f59e0b;
            color: #f59e0b;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.3);
        }

        .streak-icon {
            font-size: 1.2rem;
            filter: drop-shadow(0 0 5px rgba(251, 191, 36, 0.5));
        }

        .feelings-header-button {
            position: relative;
            top: auto;
            left: auto;
            background: rgba(139, 92, 246, 0.2);
            border: 2px solid #8b5cf6;
            color: #8b5cf6;
            padding: 0.5rem 1rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
            font-weight: bold;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .feelings-header-button:hover {
            background: rgba(139, 92, 246, 0.3);
            border-color: #7c3aed;
            color: #7c3aed;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }

        .feelings-icon {
            font-size: 1.2rem;
            filter: drop-shadow(0 0 5px rgba(139, 92, 246, 0.5));
        }

        .checklist-header-button {
            position: relative;
            top: auto;
            left: auto;
            background: rgba(34, 197, 94, 0.2);
            border: 2px solid #22c55e;
            color: #22c55e;
            padding: 0.5rem 1rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
            font-weight: bold;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .checklist-header-button:hover {
            background: rgba(34, 197, 94, 0.3);
            border-color: #16a34a;
            color: #16a34a;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
        }

        .checklist-icon {
            font-size: 1.2rem;
            filter: drop-shadow(0 0 5px rgba(34, 197, 94, 0.5));
        }

        .badge-header-button {
            position: relative;
            top: auto;
            left: auto;
            background: rgba(139, 92, 246, 0.15);
            border: 2px solid rgba(139, 92, 246, 0.4);
            padding: 0.3rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .badge-header-button:hover {
            background: rgba(139, 92, 246, 0.25);
            border-color: rgba(139, 92, 246, 0.6);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }

        .badge-header-button img {
            width: 36px;
            height: 36px;
            object-fit: contain;
        }

        .badge-modal-content {
            text-align: center;
            padding: 1rem;
        }

        .badge-display {
            margin: 1.5rem 0;
        }

        .badge-display img {
            width: 150px;
            height: 150px;
            object-fit: contain;
            transition: transform 0.3s ease;
        }

        .badge-display img:hover {
            transform: scale(1.05);
        }

        .badge-progress {
            margin-top: 1.5rem;
            padding: 1rem;
            background: rgba(30, 41, 59, 0.6);
            border-radius: 12px;
            border: 1px solid #334155;
        }

        .badge-progress-bar {
            width: 100%;
            height: 12px;
            background: rgba(15, 23, 42, 0.8);
            border-radius: 6px;
            margin-top: 0.75rem;
            overflow: hidden;
        }

        .badge-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #8b5cf6, #a78bfa);
            border-radius: 6px;
            transition: width 0.5s ease;
        }

        .badge-earned .badge-progress-fill {
            background: linear-gradient(90deg, #f59e0b, #fbbf24);
        }

        .badge-progress-text {
            color: #94a3b8;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .badge-earned-text {
            color: #fbbf24;
            font-weight: bold;
            margin-top: 1rem;
            font-size: 1.1rem;
        }

        .logout-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: var(--secondary);
            border: 1px solid var(--border);
            color: var(--foreground);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
            backdrop-filter: blur(10px);
        }

        .logout-button:hover {
            background: var(--accent);
            border-color: var(--border);
        }

        .safety-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card);
            border-top: 1px solid var(--border);
            padding: 0.75rem 1rem;
            color: var(--muted-foreground);
            font-size: 0.85rem;
            text-align: center;
            z-index: 1000;
            box-shadow: 0 -2px 10px var(--shadow-color);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .safety-footer strong {
            color: var(--foreground);
        }

        .main-content {
            display: flex;
            flex: 1;
            gap: 1rem;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            padding: 0 1rem;
            margin-bottom: 50px; /* Space for footer */
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--chat-area-bg, var(--card));
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -10px 30px var(--shadow-color);
            height: calc(100vh - 150px);
            max-height: calc(100vh - 150px);
            border: 1px solid var(--border);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .hotlines-sidebar {
            width: 300px;
            background: var(--chat-area-bg, var(--background-secondary));
            border-radius: 20px;
            padding: 1rem;
            box-shadow: 0 4px 20px var(--shadow-color);
            height: fit-content;
            position: sticky;
            top: 1rem;
            border: 1px solid var(--border);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .sidebar-header h3 {
            color: var(--muted-foreground);
            margin-bottom: 1rem;
            text-align: center;
            font-size: 1.1rem;
        }

        .hotline-section {
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border);
        }

        .hotline-section:last-child {
            border-bottom: none;
        }

        .hotline-section h4 {
            color: var(--foreground);
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }

        .hotline-item {
            margin-bottom: 0.5rem;
            padding: 0.4rem;
            background: var(--card);
            border-radius: 6px;
            border-left: 3px solid var(--primary);
        }

        .hotline-item strong {
            color: var(--foreground);
            display: block;
            margin-bottom: 0.2rem;
            font-size: 0.85rem;
        }

        .hotline-item p {
            color: var(--muted-foreground);
            font-weight: bold;
            margin: 0;
            font-size: 0.8rem;
        }

        .sidebar-footer {
            text-align: center;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border);
        }

        .sidebar-footer p {
            color: var(--muted-foreground);
            font-size: 0.8rem;
            margin: 0;
        }

        /* Hide close button on desktop - only show on mobile */
        .sidebar-close-button {
            display: none;
        }

        .messages {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            min-height: 0;
        }

        .chat-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-secondary);
            gap: 1rem;
        }

        .chat-loading p {
            margin: 0;
            font-size: 0.95rem;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--background-tertiary);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .message {
            margin-bottom: 1rem;
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background: var(--primary);
            color: var(--primary-foreground);
        }

        .message.assistant .message-avatar {
            background: var(--primary);
            color: var(--primary-foreground);
        }

        .message-content {
            background: var(--message-bot-bg);
            padding: 0.75rem 1rem;
            border-radius: 18px;
            max-width: 70%;
            word-wrap: break-word;
            line-height: 1.4;
            color: var(--message-bot-text);
            border: none;
            transition: background 0.3s ease;
        }

        .message.user .message-content {
            background: var(--message-user-bg);
            color: var(--message-user-text);
            border: 1px solid var(--message-user-border);
        }

        .message.crisis .message-content {
            background: #fef2f2;
            border: 2px solid #dc2626;
            color: #991b1b;
        }

        .message.safety .message-content {
            background: #eff6ff;
            border: 2px solid #2563eb;
            color: #1e40af;
        }

        .input-container {
            padding: 1rem;
            background: var(--background-secondary);
            border-radius: 0 0 20px 20px;
            box-shadow: 0 -2px 10px var(--shadow-color);
            border-top: 1px solid var(--border);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .input-group {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .message-input {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: 25px;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.2s, background-color 0.3s ease;
            background: var(--input-bg);
            color: var(--input-text);
        }

        .message-input:focus {
            border-color: var(--primary);
        }

        .message-input::placeholder {
            color: var(--muted-foreground);
        }

        .send-button {
            background: var(--primary);
            color: var(--primary-foreground);
            border: none;
            padding: 0.75rem 1rem;
            border-radius: 50%;
            cursor: pointer;
            transition: background 0.2s, transform 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 50px;
            height: 50px;
        }

        .send-button:hover {
            opacity: 0.9;
            transform: scale(1.05);
        }

        .send-button:disabled {
            background: var(--muted);
            color: var(--muted-foreground);
            cursor: not-allowed;
            transform: none;
        }

        .typing-indicator {
            display: none;
            padding: 0.75rem 1rem;
            color: var(--muted-foreground);
            font-style: italic;
        }

        .crisis-resources {
            background: #fef2f2;
            border: 2px solid #dc2626;
            margin: 1rem;
            padding: 1rem;
            border-radius: 12px;
            color: #991b1b;
        }

        .crisis-resources h3 {
            color: #dc2626;
            margin-bottom: 0.5rem;
        }

        .crisis-resources a {
            color: #dc2626;
            text-decoration: none;
            font-weight: bold;
        }

        .crisis-resources a:hover {
            text-decoration: underline;
        }

        /* Hamburger Menu Button for Mobile */
        .hamburger-button {
            display: none;
            position: absolute;
            top: 3.5rem;
            right: 1rem;
            background: rgba(217, 119, 6, 0.9);
            color: white;
            border: 1px solid #fbbf24;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            cursor: pointer;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            font-size: 1.5rem;
            transition: all 0.2s ease;
            line-height: 1;
            backdrop-filter: blur(10px);
        }

        .hamburger-button:hover {
            background: rgba(180, 83, 9, 0.95);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.3);
        }

        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            backdrop-filter: blur(2px);
        }

        .sidebar-overlay.active {
            display: block;
        }

        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
                padding: 0;
            }

            .header {
                padding-bottom: 3.5rem;
            }

            .feature-buttons-container {
                position: absolute;
                top: auto;
                bottom: 0.5rem;
                left: 50%;
                transform: translateX(-50%);
                gap: 0.4rem;
                align-items: center;
            }

            .feelings-header-button,
            .streak-header-button,
            .checklist-header-button,
            .badge-header-button {
                padding: 0.4rem 0.5rem;
                font-size: 0.8rem;
                border-radius: 8px;
                height: 36px;
                display: flex;
                align-items: center;
                justify-content: center;
                box-sizing: border-box;
            }

            /* Hide streak count number on mobile for compact icon-only display */
            .streak-header-button #headerStreakCount {
                display: none;
            }

            .feelings-icon,
            .streak-icon,
            .checklist-icon {
                font-size: 1.1rem;
            }

            .badge-header-button {
                padding: 0.3rem;
            }

            .badge-header-button img {
                width: 28px;
                height: 28px;
            }

            .chat-container {
                border-radius: 0;
                margin: 0;
                min-height: 100%;
                height: calc(100vh - 180px);
                width: 100%;
                padding-bottom: 0;
            }

            .messages {
                padding-bottom: 90px;
            }

            .input-container {
                position: fixed;
                bottom: 50px;
                left: 0;
                right: 0;
                border-radius: 0;
                background: var(--background-secondary);
                z-index: 100;
                margin: 0;
            }

            .theme-toggle {
                right: 4.5rem;
                width: 36px;
                height: 36px;
                font-size: 1rem;
            }

            .safety-footer {
                position: fixed;
                bottom: 0;
                z-index: 99;
            }

            .message-content {
                max-width: 85%;
            }

            .header h1 {
                font-size: 1.2rem;
            }

            .header p {
                font-size: 0.8rem;
                display: none;
            }

            .logout-button {
                padding: 0.4rem 0.75rem;
                font-size: 0.85rem;
            }

            /* Sliding sidebar for mobile */
            .hotlines-sidebar {
                position: fixed;
                top: 0;
                right: -100%;
                width: 85%;
                max-width: 350px;
                height: 100vh;
                background: var(--card);
                border-radius: 0;
                margin: 0;
                padding: 1rem;
                z-index: 2500;
                transition: right 0.3s ease;
                overflow-y: auto;
                box-shadow: -4px 0 20px var(--shadow-heavy);
            }

            .hotlines-sidebar.active {
                right: 0;
            }

            .sidebar-close-button {
                position: absolute;
                top: 1rem;
                right: 1rem;
                background: var(--secondary);
                border: none;
                color: var(--foreground);
                width: 32px;
                height: 32px;
                border-radius: 50%;
                cursor: pointer;
                font-size: 1.2rem;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .hamburger-button {
                display: flex;
                align-items: center;
                justify-content: center;
                top: 3.5rem;
                right: 1rem;
                width: 36px;
                height: 36px;
                font-size: 1.3rem;
            }

            .streak-container {
                padding: 1.5rem;
            }

            .streak-flame {
                font-size: 3rem;
            }

            .streak-count {
                font-size: 2rem;
            }

            .day-circle {
                width: 40px;
                height: 40px;
                font-size: 2rem;
            }

            .day-label {
                font-size: 0.65rem;
            }

            .hotlines-sidebar .hotline-section {
                display: block;
                width: 100%;
                margin-right: 0;
            }

            .safety-footer {
                font-size: 0.75rem;
                padding: 0.5rem;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1rem;
            }

            .header p {
                display: none;
            }

            .header-logo {
                width: 35px;
                height: 35px;
            }

            .logout-button {
                padding: 0.3rem 0.6rem;
                font-size: 0.8rem;
                top: 0.75rem;
                right: 0.75rem;
            }

            .hotlines-sidebar .hotline-section {
                width: 100%;
                margin-right: 0;
            }

            .hamburger-button {
                width: 32px;
                height: 32px;
                font-size: 1.2rem;
                top: 2.75rem;
                right: 0.75rem;
            }

            .streak-container {
                padding: 1rem;
            }

            .streak-flame {
                font-size: 2.5rem;
            }

            .streak-count {
                font-size: 1.75rem;
            }

            .streak-label {
                font-size: 0.8rem;
            }

            .streak-message {
                font-size: 0.75rem;
            }

            .day-circle {
                width: 32px;
                height: 32px;
                font-size: 1.6rem;
            }

            .weekly-calendar {
                gap: 0.15rem;
            }

            .calendar-day {
                flex: 0 0 auto;
                min-width: 32px;
            }

            .day-label {
                font-size: 0.6rem;
                margin-bottom: 0.3rem;
            }

            .streak-container {
                padding: 1.25rem;
                max-width: 95vw;
            }
        }

        /* Install prompt */
        .install-prompt {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--card);
            color: var(--foreground);
            padding: 1rem 1.5rem;
            border-radius: 25px;
            box-shadow: 0 4px 20px var(--shadow-heavy);
            display: none;
            z-index: 1000;
            border: 1px solid var(--border);
        }

        .install-prompt button {
            background: var(--primary);
            color: var(--primary-foreground);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            margin-left: 1rem;
            cursor: pointer;
            font-weight: bold;
        }

        .install-prompt button:hover {
            opacity: 0.9;
        }

        /* Streak Modal Styles */
        .streak-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            backdrop-filter: blur(4px);
        }

        .streak-modal-overlay.active {
            display: flex;
        }

        .streak-container {
            background: var(--card);
            border-radius: 20px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 40px var(--shadow-heavy);
            border: 1px solid var(--border);
            position: relative;
            transition: background-color 0.3s ease;
        }

        .streak-close-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: var(--secondary);
            border: none;
            color: var(--foreground);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .streak-close-button:hover {
            background: var(--accent);
        }

        .streak-header {
            text-align: center;
            margin-bottom: 1rem;
        }

        .streak-flame {
            font-size: 4rem;
            margin-bottom: 0.5rem;
            filter: drop-shadow(0 0 10px rgba(251, 191, 36, 0.5));
        }

        .streak-count {
            font-size: 2.5rem;
            font-weight: bold;
            color: #a78bfa;
            margin-bottom: 0.25rem;
        }

        .streak-label {
            color: #cbd5e1;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .streak-message {
            text-align: center;
            color: #94a3b8;
            font-size: 0.85rem;
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: rgba(251, 191, 36, 0.1);
            border-radius: 8px;
        }

        .weekly-calendar {
            display: flex;
            justify-content: space-between;
            gap: 0.5rem;
            margin-top: 1.5rem;
        }

        .calendar-day {
            flex: 1;
            text-align: center;
        }

        .day-label {
            color: #64748b;
            font-size: 0.7rem;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
        }

        .day-circle {
            width: 50px;
            height: 50px;
            margin: 0 auto;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            position: relative;
            font-size: 2.5rem;
            transition: all 0.3s ease;
        }

        .day-circle.active::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 80%;
            background-image: url('/static/hot_chai.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            filter: drop-shadow(0 0 8px rgba(251, 191, 36, 0.6));
            animation: steam 2s ease-in-out infinite;
        }

        @keyframes steam {
            0%, 100% { transform: translate(-50%, -50%) translateY(0px); }
            50% { transform: translate(-50%, -50%) translateY(-2px); }
        }

        .day-circle.frozen::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 80%;
            background-image: url('/static/cold_chai.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            filter: drop-shadow(0 0 10px rgba(147, 197, 253, 0.8));
        }

        .day-circle.today {
            transform: scale(1.15);
            background: rgba(96, 165, 250, 0.15);
            border-radius: 50%;
        }

        .day-circle.inactive::after {
            content: 'ü´ñ';
            opacity: 0.3;
            filter: grayscale(100%);
        }

        .day-circle.missed::after {
            content: '‚úñ';
            opacity: 0.5;
            color: #64748b;
            font-size: 1.8rem;
        }

        /* Feelings Thermometer Styles */
        .feelings-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .feelings-modal {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 2rem;
            max-width: 400px;
            width: 90%;
            text-align: center;
            color: var(--foreground);
            box-shadow: 0 10px 40px var(--shadow-heavy);
            transition: background-color 0.3s ease;
        }

        .feelings-modal h2 {
            color: var(--primary);
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }

        .feelings-modal p {
            color: var(--muted-foreground);
            margin-bottom: 2rem;
            line-height: 1.5;
        }

        .thermometer-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 2rem 0;
            gap: 0.5rem;
        }

        .thermometer-number {
            background: var(--secondary);
            border: 2px solid var(--border);
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--foreground);
            font-weight: bold;
            font-size: 0.9rem;
        }

        .thermometer-number:hover {
            transform: scale(1.1);
            border-color: var(--primary);
        }

        .thermometer-number.selected {
            background: var(--primary);
            border-color: var(--primary);
            color: var(--primary-foreground);
            transform: scale(1.1);
        }

        .feelings-scale {
            display: flex;
            justify-content: space-between;
            margin: 1rem 0;
            font-size: 0.8rem;
            color: var(--muted-foreground);
        }

        .feelings-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .feelings-button {
            flex: 1;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s ease;
        }

        .feelings-submit {
            background: var(--primary);
            color: var(--primary-foreground);
        }

        .feelings-submit:hover:not(:disabled) {
            opacity: 0.9;
        }

        .feelings-submit:disabled {
            background: var(--muted);
            color: var(--muted-foreground);
            cursor: not-allowed;
        }

        .feelings-skip {
            background: var(--secondary);
            color: var(--foreground);
        }

        .feelings-skip:hover {
            background: var(--accent);
        }

        /* Checklist styles */
        .checklist-item.completed {
            background: rgba(34, 197, 94, 0.1) !important;
            border-color: #22c55e !important;
        }
        .checklist-item.completed .checklist-checkbox {
            background: #22c55e !important;
            border-color: #22c55e !important;
        }
        .checklist-item.completed .checklist-checkbox::after {
            content: '‚úì';
            color: white;
            font-size: 1rem;
            font-weight: bold;
        }

        @media (max-width: 480px) {
            .thermometer-number {
                width: 30px;
                height: 30px;
                font-size: 0.8rem;
            }

            .feelings-modal {
                padding: 1.5rem;
            }

            .feature-buttons-container {
                gap: 0.25rem;
            }

            .feelings-header-button,
            .streak-header-button,
            .checklist-header-button,
            .badge-header-button {
                padding: 0.25rem 0.4rem;
                font-size: 0.75rem;
                border-width: 1px;
                height: 32px;
            }

            .badge-header-button {
                padding: 0.2rem;
            }

            .badge-header-button img {
                width: 24px;
                height: 24px;
            }

            .feelings-icon,
            .streak-icon,
            .checklist-icon {
                font-size: 0.95rem;
            }

            .theme-toggle {
                right: 4rem;
                width: 32px;
                height: 32px;
                font-size: 0.9rem;
            }
        }

        /* Extra small phones */
        @media (max-width: 380px) {
            .day-circle {
                width: 28px;
                height: 28px;
                font-size: 1.4rem;
            }

            .weekly-calendar {
                gap: 0.1rem;
            }

            .calendar-day {
                min-width: 28px;
            }

            .day-label {
                font-size: 0.55rem;
            }

            .streak-container {
                padding: 1rem;
            }

            .streak-flame {
                font-size: 2rem;
            }

            .streak-count {
                font-size: 1.5rem;
            }

            .feature-buttons-container {
                gap: 0.15rem;
            }

            .feelings-header-button,
            .streak-header-button,
            .checklist-header-button,
            .badge-header-button {
                padding: 0.2rem 0.3rem;
                font-size: 0.7rem;
                height: 28px;
            }

            .badge-header-button {
                padding: 0.15rem;
            }

            .badge-header-button img {
                width: 20px;
                height: 20px;
            }

            .feelings-icon,
            .streak-icon,
            .checklist-icon {
                font-size: 0.85rem;
            }
        }
    </style>
</head>
<body>
            <div class="header">
            <!-- Feature buttons container -->
            <div class="feature-buttons-container">
                <!-- Daily Check-ins button first (everyone has access) -->
                <button class="feelings-header-button" id="feelingsHeaderButton" onclick="openFeelingsModal()" title="Daily Check-in">
                    <span class="feelings-icon">üå°Ô∏è</span>
                </button>
                <!-- Streak button (only for 'full' feature group) -->
                <button class="streak-header-button" id="streakHeaderButton" onclick="openStreakModal()" style="display: none;" title="Your Streak">
                    <span class="streak-icon">üî•</span>
                    <span id="headerStreakCount">0</span>
                </button>
                <!-- Checklist button (only for 'full' feature group) -->
                <button class="checklist-header-button" id="checklistHeaderButton" onclick="openChecklistModal()" style="display: none;" title="Self-care Checklist">
                    <span class="checklist-icon">‚úÖ</span>
                </button>
                <!-- Badge button (only for 'full' feature group) -->
                <button class="badge-header-button" id="badgeHeaderButton" onclick="openBadgeModal()" style="display: none;" title="Your Badges">
                    <img id="badgeHeaderIcon" src="/static/15_days_before.png" alt="15 Day Badge">
                </button>
            </div>
            <h1>
                <img src="/logo.jpeg" alt="MindMitra Logo" class="header-logo">
                MindMitra
            </h1>
            <p>Your mental health companion and guide</p>
            <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()" title="Toggle theme">
                <i class="fas fa-sun" id="themeIcon"></i>
            </button>
            <button class="logout-button" onclick="logout()" title="Logout">Logout</button>
            <button class="hamburger-button" id="hamburgerButton" onclick="toggleHelplines()" title="Emergency Helplines">‚ò∞</button>
        </div>

    <div class="main-content">
        <div class="chat-container">
            <div class="messages" id="messages">
                <!-- Loading indicator shown while fetching chat history -->
                <div id="chat-loading" class="chat-loading">
                    <div class="loading-spinner"></div>
                    <p>Loading your conversation...</p>
                </div>
            </div>

            <div class="typing-indicator" id="typing">
                <i class="fas fa-circle"></i> Bot is typing...
            </div>

            <div class="input-container">
                <div class="input-group">
                    <input type="text" class="message-input" id="messageInput" placeholder="How are you feeling today?" maxlength="500">
                    <button class="send-button" id="sendButton" onclick="sendMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>

        <div class="hotlines-sidebar" id="hotlinesSidebar">
            <button class="sidebar-close-button" onclick="toggleHelplines()">√ó</button>
            <div class="sidebar-header">
                <h3>üìû Emergency Helplines</h3>
            </div>
            
            <div class="hotline-section">
                <h4>üö® Crisis Support</h4>
                <div class="hotline-item">
                    <strong>AASRA</strong>
                    <p>022 2754 6669</p>
                </div>
                <div class="hotline-item">
                    <strong>Kiran Helpline</strong>
                    <p>1800-599-0019</p>
                </div>
                <div class="hotline-item">
                    <strong>Tele Manas</strong>
                    <p>1800-891-4416</p>
                </div>
            </div>

            <div class="hotline-section">
                <h4>üÜò Emergency Services</h4>
                <div class="hotline-item">
                    <strong>Police</strong>
                    <p>100</p>
                </div>
                <div class="hotline-item">
                    <strong>Ambulance</strong>
                    <p>102</p>
                </div>
                <div class="hotline-item">
                    <strong>Emergency</strong>
                    <p>112</p>
                </div>
                <div class="sidebar-footer">
                    <p><strong>üíõ You're not alone. Help is available 24/7.</strong></p>
                </div>
            </div>
            
        </div>
    </div>

    <!-- Sidebar overlay for mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleHelplines()"></div>

    <div class="install-prompt" id="installPrompt">
        <span>Install this app for a better experience</span>
        <button onclick="installApp()">Install</button>
    </div>

    <!-- Safety Footer -->
    <div class="safety-footer">
        ‚ö†Ô∏è <strong>Important Notice</strong>: This is a non-clinical support tool for general mental wellness. If you're experiencing a crisis, please refer to the emergency helplines.
    </div>

    <!-- Streak Modal -->
    <div class="streak-modal-overlay" id="streakModal">
        <div class="streak-container" id="streakContainer">
            <button class="streak-close-button" onclick="closeStreakModal()">√ó</button>
            <div class="streak-header">
                <div class="streak-flame">üî•</div>
                <div class="streak-count" id="streakCount">0</div>
                <div class="streak-label">day streak</div>
            </div>
            <div class="streak-message" id="streakMessage">
                Send a message today to keep your streak alive!
            </div>
            <div style="text-align: center; margin-top: 0.5rem; padding: 0.5rem; background: rgba(251, 191, 36, 0.05); border-radius: 6px; color: #94a3b8; font-size: 0.75rem;">
                üí¨ Send <strong style="color: #fbbf24;">1+ message</strong> per day to keep your streak ‚Ä¢ ‚ùÑÔ∏è Miss a day? Auto-freeze saves you once per week
            </div>
            <div class="weekly-calendar" id="weeklyCalendar">
                <!-- Calendar days will be generated by JavaScript -->
            </div>
            <div id="autoFreezeMessage" style="margin-top: 0.75rem; padding: 0.5rem; border-radius: 8px; font-size: 0.8rem; display: none; text-align: center; background: rgba(59, 130, 246, 0.1); color: #60a5fa;"></div>
        </div>
    </div>

    <!-- Feelings Thermometer Modal -->
    <div class="feelings-overlay" id="feelingsOverlay">
        <div class="feelings-modal">
            <h2>üå°Ô∏è Daily Check-In</h2>
            <p>How are you feeling today? Rate your overall mood on a scale of 0-10.</p>

            <div class="thermometer-container" id="thermometerContainer">
                <!-- Numbers 0-10 will be generated by JavaScript -->
            </div>

            <div class="feelings-scale">
                <span>üòû Very Low</span>
                <span>üòê Neutral</span>
                <span>üòä Great</span>
            </div>

            <div class="feelings-buttons">
                <button class="feelings-button feelings-skip" onclick="skipFeelingsCheck()">Skip Today</button>
                <button class="feelings-button feelings-submit" id="submitFeeling" onclick="submitFeeling()" disabled>Submit</button>
            </div>
        </div>
    </div>

    <!-- Checklist Modal -->
    <div class="streak-modal-overlay" id="checklistModal">
        <div class="streak-container" style="max-width: 500px; max-height: 90vh; overflow-y: auto;">
            <button class="streak-close-button" onclick="closeChecklistModal()">√ó</button>
            <div class="streak-header">
                <div class="streak-flame">‚ú®</div>
                <div class="streak-count">Daily Checklist</div>
                <div class="streak-label">Small steps for well-being</div>
            </div>
            <div id="checklistItems" style="margin-top: 0.75rem;">
                <div class="checklist-item" data-item="move" onclick="toggleChecklistItem('move')" style="background: rgba(30,41,59,0.6); border: 1px solid #334155; border-radius: 10px; padding: 0.6rem 0.75rem; margin-bottom: 0.4rem; cursor: pointer; display: flex; gap: 0.6rem; align-items: center;">
                    <div class="checklist-checkbox" style="width:20px;height:20px;min-width:20px;border:2px solid #64748b;border-radius:5px;display:flex;align-items:center;justify-content:center;background:rgba(15,23,42,0.6);"></div>
                    <div style="flex:1"><strong style="color:#e2e8f0;font-size:0.85rem;">üèÉ Move Your Body</strong><span style="color:#94a3b8;font-size:0.75rem;margin-left:0.5rem;">15 min walk, stretch, or dance</span></div>
                </div>
                <div class="checklist-item" data-item="breathe" onclick="toggleChecklistItem('breathe')" style="background: rgba(30,41,59,0.6); border: 1px solid #334155; border-radius: 10px; padding: 0.6rem 0.75rem; margin-bottom: 0.4rem; cursor: pointer; display: flex; gap: 0.6rem; align-items: center;">
                    <div class="checklist-checkbox" style="width:20px;height:20px;min-width:20px;border:2px solid #64748b;border-radius:5px;display:flex;align-items:center;justify-content:center;background:rgba(15,23,42,0.6);"></div>
                    <div style="flex:1"><strong style="color:#e2e8f0;font-size:0.85rem;">üßò Mindful Break</strong><span style="color:#94a3b8;font-size:0.75rem;margin-left:0.5rem;">3 min breathing</span></div>
                </div>
                <div class="checklist-item" data-item="journal" onclick="toggleChecklistItem('journal')" style="background: rgba(30,41,59,0.6); border: 1px solid #334155; border-radius: 10px; padding: 0.6rem 0.75rem; margin-bottom: 0.4rem; cursor: pointer; display: flex; gap: 0.6rem; align-items: center;">
                    <div class="checklist-checkbox" style="width:20px;height:20px;min-width:20px;border:2px solid #64748b;border-radius:5px;display:flex;align-items:center;justify-content:center;background:rgba(15,23,42,0.6);"></div>
                    <div style="flex:1"><strong style="color:#e2e8f0;font-size:0.85rem;">üìù Daily Reflection</strong><span style="color:#94a3b8;font-size:0.75rem;margin-left:0.5rem;">Write your thoughts</span></div>
                </div>
                <div class="checklist-item" data-item="gratitude" onclick="toggleChecklistItem('gratitude')" style="background: rgba(30,41,59,0.6); border: 1px solid #334155; border-radius: 10px; padding: 0.6rem 0.75rem; margin-bottom: 0.4rem; cursor: pointer; display: flex; gap: 0.6rem; align-items: center;">
                    <div class="checklist-checkbox" style="width:20px;height:20px;min-width:20px;border:2px solid #64748b;border-radius:5px;display:flex;align-items:center;justify-content:center;background:rgba(15,23,42,0.6);"></div>
                    <div style="flex:1"><strong style="color:#e2e8f0;font-size:0.85rem;">üôè Gratitude Moment</strong><span style="color:#94a3b8;font-size:0.75rem;margin-left:0.5rem;">One thing you're thankful for</span></div>
                </div>
                <div class="checklist-item" data-item="kindness" onclick="toggleChecklistItem('kindness')" style="background: rgba(30,41,59,0.6); border: 1px solid #334155; border-radius: 10px; padding: 0.6rem 0.75rem; margin-bottom: 0.4rem; cursor: pointer; display: flex; gap: 0.6rem; align-items: center;">
                    <div class="checklist-checkbox" style="width:20px;height:20px;min-width:20px;border:2px solid #64748b;border-radius:5px;display:flex;align-items:center;justify-content:center;background:rgba(15,23,42,0.6);"></div>
                    <div style="flex:1"><strong style="color:#e2e8f0;font-size:0.85rem;">üíö Spread Kindness</strong><span style="color:#94a3b8;font-size:0.75rem;margin-left:0.5rem;">Do something kind</span></div>
                </div>
            </div>
            <div style="margin-top:1rem;padding:0.75rem;background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.3);border-radius:10px;text-align:center;">
                <div id="checklistProgressText" style="color:#22c55e;font-size:0.9rem;font-weight:bold;">0 / 5 completed</div>
                <div style="width:100%;height:6px;background:rgba(30,41,59,0.6);border-radius:3px;margin-top:0.4rem;overflow:hidden;"><div id="checklistProgressFill" style="height:100%;background:linear-gradient(90deg,#22c55e,#16a34a);border-radius:3px;width:0%;transition:width 0.3s ease;"></div></div>
                <div id="checklistComparison" style="margin-top:0.5rem;"></div>
            </div>
        </div>
    </div>

    <!-- Badge Modal -->
    <div class="streak-modal-overlay" id="badgeModal">
        <div class="streak-container" style="max-width: 400px;">
            <button class="streak-close-button" onclick="closeBadgeModal()">√ó</button>
            <div class="streak-header">
                <div class="streak-flame">üèÜ</div>
                <div class="streak-count">Achievements</div>
                <div class="streak-label">Your progress badges</div>
            </div>
            <div class="badge-modal-content">
                <div class="badge-display">
                    <img id="badgeModalImage" src="/static/15_days_before.png" alt="15 Day Badge">
                </div>
                <div class="badge-progress" id="badgeProgressSection">
                    <div class="badge-progress-text" id="badgeProgressText">
                        Chat on <strong id="badgeDaysCount">0</strong> / 15 days to unlock
                    </div>
                    <div class="badge-progress-bar">
                        <div class="badge-progress-fill" id="badgeProgressFill" style="width: 0%;"></div>
                    </div>
                </div>
                <div class="badge-earned-text" id="badgeEarnedText" style="display: none;">
                    üéâ Badge Earned! You've chatted for 15 days!
                </div>
            </div>
        </div>
    </div>

    <script>
        let deferredPrompt;
        let userId = null;
        let selectedFeeling = null;
        let userFeatureGroup = 'full';  // Default to 'full' group

        // Theme Toggle Functions
        function initTheme() {
            const savedTheme = localStorage.getItem('mindmitra_theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

            // Default to dark mode, or use saved preference
            if (savedTheme === 'light') {
                document.body.classList.remove('dark');
                updateThemeIcon(false);
            } else {
                document.body.classList.add('dark');
                updateThemeIcon(true);
            }
        }

        function toggleTheme() {
            const isDark = document.body.classList.toggle('dark');
            localStorage.setItem('mindmitra_theme', isDark ? 'dark' : 'light');
            updateThemeIcon(isDark);

            // Update meta theme-color for PWA
            const metaTheme = document.querySelector('meta[name="theme-color"]');
            if (metaTheme) {
                metaTheme.content = isDark ? '#0a0a0a' : '#fafafa';
            }
        }

        function updateThemeIcon(isDark) {
            const icon = document.getElementById('themeIcon');
            if (icon) {
                icon.className = isDark ? 'fas fa-sun' : 'fas fa-moon';
            }
        }

        // Initialize theme immediately to prevent flash
        initTheme();
        
        // Load chat history from server
        async function loadChatHistory() {
            if (!userId) {
                console.log('DEBUG: No userId set, cannot load chat history');
                return;
            }

            console.log(`DEBUG: Loading chat history for user: ${userId}`);

            try {
                const response = await fetch(`/api/session/${userId}`);
                console.log(`DEBUG: API response status: ${response.status}`);

                const data = await response.json();
                console.log(`DEBUG: API response data:`, data);

                const messagesContainer = document.getElementById('messages');

                if (data.messages && data.messages.length > 0) {
                    console.log(`DEBUG: Found ${data.messages.length} previous messages`);

                    // Add all previous messages
                    data.messages.forEach((msg, index) => {
                        console.log(`DEBUG: Adding message ${index + 1}: ${msg.role} - ${msg.content.substring(0, 50)}...`);
                        addMessage(msg.content, msg.role);
                    });

                    console.log(`‚úÖ Successfully loaded ${data.messages.length} previous messages`);
                } else {
                    console.log('DEBUG: No previous messages found, adding initial greeting');
                    // First time user - add initial greeting and save it to database
                    const greeting = "Hi there! I'm here to listen and support you. How are you feeling today?";
                    addMessage(greeting, 'assistant');

                    // Save initial greeting to database
                    try {
                        await fetch('/api/chat/init', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                user_id: userId,
                                message: greeting
                            })
                        });
                        console.log('DEBUG: Initial greeting saved to database');
                    } catch (error) {
                        console.error('Error saving initial greeting:', error);
                    }
                }
            } catch (error) {
                console.error('‚ùå Error loading chat history:', error);
            }
        }

        // Check authentication on page load - OPTIMIZED: single API call
        function checkAuth() {
            const loginId = localStorage.getItem('mindmitra_login_id');
            console.log(`DEBUG: Checking auth, loginId from localStorage: ${loginId}`);

            if (!loginId) {
                console.log('DEBUG: No loginId found, redirecting to login');
                window.location.href = '/login';
                return;
            }

            // OPTIMIZATION: Show UI immediately based on cached feature group
            const cachedFeatureGroup = localStorage.getItem('mindmitra_feature_group');
            if (cachedFeatureGroup) {
                console.log('DEBUG: Using cached feature group:', cachedFeatureGroup);
                applyFeatureGroup(cachedFeatureGroup);
            }

            // OPTIMIZATION: Single API call that returns ALL data
            fetch('/api/init', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ login_id: loginId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.valid) {
                    // Check if user needs to consent
                    if (data.needs_consent) {
                        console.log('DEBUG: User needs to consent, redirecting to consent page');
                        window.location.href = '/consent';
                        return;
                    }

                    userId = loginId;
                    console.log(`DEBUG: Authentication successful, userId set to: ${userId}`);

                    // Load user info and feature group
                    if (data.user) {
                        console.log('Logged in as:', data.user.login_id);
                        userFeatureGroup = data.user.feature_group || 'full';
                        console.log('Feature group:', userFeatureGroup);

                        // Cache feature group for instant UI on next visit
                        localStorage.setItem('mindmitra_feature_group', userFeatureGroup);

                        // Apply feature group (update UI if different from cached)
                        applyFeatureGroup(userFeatureGroup);
                    }

                    // OPTIMIZATION: Use chat history from init response (no extra API call)
                    if (data.chat_history && data.chat_history.length > 0) {
                        console.log(`DEBUG: Loaded ${data.chat_history.length} messages from init`);
                        displayChatHistory(data.chat_history);
                    } else {
                        // Show welcome message if no history
                        showWelcomeMessage();
                    }

                    // OPTIMIZATION: Use feeling status from init response (no extra API call)
                    if (data.feeling_status) {
                        applyFeelingStatus(data.feeling_status);
                    }

                    // OPTIMIZATION: Use streak data from init response (no extra API call)
                    if (data.streak_data && userFeatureGroup === 'full') {
                        applyStreakData(data.streak_data);
                    }

                    // Load checklist state from localStorage
                    loadChecklistState();

                } else {
                    // Handle restricted account
                    if (data.restricted) {
                        alert(data.error || 'Your account has been restricted.');
                    }
                    // Clear invalid session and redirect to login
                    localStorage.removeItem('mindmitra_login_id');
                    localStorage.removeItem('mindmitra_user_type');
                    localStorage.removeItem('mindmitra_feature_group');
                    window.location.href = '/login';
                }
            })
            .catch(error => {
                console.error('Auth/init error:', error);
                localStorage.removeItem('mindmitra_login_id');
                localStorage.removeItem('mindmitra_user_type');
                localStorage.removeItem('mindmitra_feature_group');
                window.location.href = '/login';
            });
        }

        // Apply feature group to UI
        // basic: thermometer, badge, checklist (no streaks)
        // full: thermometer, streaks, badge, checklist
        function applyFeatureGroup(featureGroup) {
            // Badge and checklist are shown for both groups
            document.getElementById('checklistHeaderButton').style.display = 'flex';
            document.getElementById('badgeHeaderButton').style.display = 'flex';
            loadBadgeData();

            // Streaks only for full group
            if (featureGroup === 'full') {
                document.getElementById('streakHeaderButton').style.display = 'flex';
            } else {
                document.getElementById('streakHeaderButton').style.display = 'none';
            }
        }

        // Display chat history from init response - uses existing addMessage function
        function hideLoadingIndicator() {
            const loader = document.getElementById('chat-loading');
            if (loader) {
                loader.remove();
            }
        }

        function displayChatHistory(messages) {
            hideLoadingIndicator();
            const messagesContainer = document.getElementById('messages');
            messagesContainer.innerHTML = '';

            messages.forEach(msg => {
                addMessage(msg.content, msg.role);
            });
        }

        // Show welcome message for new users - uses existing addMessage function
        function showWelcomeMessage() {
            hideLoadingIndicator();
            const messagesContainer = document.getElementById('messages');
            messagesContainer.innerHTML = '';

            const welcomeMessage = "Hi there! I'm here to listen and support you. How are you feeling today?";
            addMessage(welcomeMessage, 'assistant');

            // Save welcome message to database
            fetch('/api/chat/init', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: userId, message: welcomeMessage })
            }).catch(err => console.error('Failed to save welcome message:', err));
        }

        // Apply feeling status from init response
        function applyFeelingStatus(status) {
            if (status.has_recorded) {
                // User already recorded feeling today
                const feelingsBtn = document.getElementById('feelingsHeaderButton');
                if (feelingsBtn) {
                    feelingsBtn.style.opacity = '0.6';
                    feelingsBtn.title = `Today's check-in: ${status.feeling_score}/10`;
                }
            }
        }

        // Apply streak data from init response - uses existing renderStreak function
        function applyStreakData(streakData) {
            if (!streakData) return;
            console.log('Applying streak data from init:', streakData);
            renderStreak(streakData);
        }
        
        // Logout function
        function logout() {
            const loginId = localStorage.getItem('mindmitra_login_id');
            if (loginId) {
                fetch('/api/auth/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ login_id: loginId })
                }).catch(error => console.error('Logout error:', error));
            }

            localStorage.removeItem('mindmitra_login_id');
            localStorage.removeItem('mindmitra_user_type');
            localStorage.removeItem('mindmitra_feature_group');
            window.location.href = '/login';
        }

        // PWA Install Prompt
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installPrompt').style.display = 'block';
        });

        async function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    console.log('User accepted the install prompt');
                }
                deferredPrompt = null;
                document.getElementById('installPrompt').style.display = 'none';
            }
        }

        // Chat functionality
        const messagesContainer = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const typingIndicator = document.getElementById('typing');

        function addMessage(content, role, type = 'normal') {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role} ${type}`;
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = role === 'user' ? 'üë§' : 'ü§ñ';
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            messageContent.innerHTML = content;
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageContent);
            messagesContainer.appendChild(messageDiv);
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showTyping() {
            typingIndicator.style.display = 'block';
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function hideTyping() {
            typingIndicator.style.display = 'none';
        }

        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            // Add user message
            addMessage(message, 'user');
            messageInput.value = '';
            sendButton.disabled = true;

            // Show typing indicator
            showTyping();

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: userId,
                        message: message
                    })
                });

                const data = await response.json();

                if (data.error) {
                    addMessage(`Error: ${data.error}`, 'assistant', 'error');
                } else if (data.restricted) {
                    // User has been restricted - log them out
                    addMessage(data.response, 'assistant', 'error');
                    setTimeout(() => {
                        alert('Your access has been restricted due to multiple safety concerns. You will be logged out.');
                        logout();
                    }, 2000);
                } else {
                    // Add bot response
                    addMessage(data.response, 'assistant', data.type);

                    // Update streak after successful message (only for 'full' group)
                    if (userFeatureGroup === 'full') {
                        loadStreakData();
                    }
                }
            } catch (error) {
                addMessage('Sorry, something went wrong. Please try again.', 'assistant', 'error');
            } finally {
                hideTyping();
                sendButton.disabled = false;
                messageInput.focus();
            }
        }

        function showCrisisResources() {
            const resourcesDiv = document.createElement('div');
            resourcesDiv.className = 'crisis-resources';
            resourcesDiv.innerHTML = `
                <h3>üö® Crisis Support Available</h3>
                <p><strong>AASRA Helpline:</strong> 022 2754 6669</p>
                <p><strong>National Crisis Helpline:</strong> 1800-599-0019</p>
                <p><strong>Emergency Services:</strong> 112</p>
                <p><strong>Police:</strong> 100</p>
            `;
            messagesContainer.appendChild(resourcesDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Enter key to send
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Focus input on load
        messageInput.focus();
        
        // Feelings Thermometer Functions
        function initFeelingsThermometer() {
            const container = document.getElementById('thermometerContainer');
            container.innerHTML = '';

            // Create numbers 0-10
            for (let i = 0; i <= 10; i++) {
                const numberDiv = document.createElement('div');
                numberDiv.className = 'thermometer-number';
                numberDiv.textContent = i;
                numberDiv.onclick = () => selectFeeling(i);
                container.appendChild(numberDiv);
            }
        }

        function selectFeeling(score) {
            selectedFeeling = score;

            // Remove previous selection
            document.querySelectorAll('.thermometer-number').forEach(num => {
                num.classList.remove('selected');
            });

            // Add selection to clicked number
            document.querySelectorAll('.thermometer-number')[score].classList.add('selected');

            // Enable submit button
            document.getElementById('submitFeeling').disabled = false;
        }

        async function checkFeelingsStatus() {
            if (!userId) return;

            try {
                const response = await fetch('/api/feelings/check', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ user_id: userId })
                });

                const data = await response.json();

                // If user hasn't recorded feeling today, show the thermometer
                if (!data.recorded_today) {
                    setTimeout(() => {
                        document.getElementById('feelingsOverlay').style.display = 'flex';
                    }, 2000); // Show after 2 seconds
                }

            } catch (error) {
                console.error('Error checking feelings status:', error);
            }
        }

        async function submitFeeling() {
            if (selectedFeeling === null) return;

            try {
                const submitButton = document.getElementById('submitFeeling');
                submitButton.disabled = true;
                submitButton.textContent = 'Submitting...';

                const response = await fetch('/api/feelings/record', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: userId,
                        feeling_score: selectedFeeling
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // Mark that user has completed feelings check at least once
                    localStorage.setItem('mindmitra_feelings_completed_' + userId, 'true');
                    
                    // Show success message briefly
                    document.querySelector('.feelings-modal h2').textContent = '‚úÖ Thank you!';
                    document.querySelector('.feelings-modal p').textContent = `Your feeling score of ${selectedFeeling}/10 has been recorded for today.`;
                    document.querySelector('.feelings-buttons').style.display = 'none';
                    document.getElementById('thermometerContainer').style.display = 'none';
                    document.querySelector('.feelings-scale').style.display = 'none';

                    // Hide modal after 2 seconds
                    setTimeout(() => {
                        document.getElementById('feelingsOverlay').style.display = 'none';
                    }, 2000);
                } else {
                    alert('Error recording feeling: ' + (data.error || 'Unknown error'));
                    submitButton.disabled = false;
                    submitButton.textContent = 'Submit';
                }

            } catch (error) {
                console.error('Error submitting feeling:', error);
                alert('Error submitting feeling. Please try again.');
                document.getElementById('submitFeeling').disabled = false;
                document.getElementById('submitFeeling').textContent = 'Submit';
            }
        }

        async function openFeelingsModal() {
            if (!userId) return;
            
            try {
                const response = await fetch('/api/feelings/check', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ user_id: userId })
                });

                const data = await response.json();

                // If already recorded today, show a different message
                if (data.recorded_today) {
                    document.querySelector('.feelings-modal h2').textContent = '‚úÖ Already Recorded';
                    document.querySelector('.feelings-modal p').textContent = `You've already recorded your feeling today (${data.feeling_score}/10). You can only submit once per day.`;
                    document.querySelector('.feelings-buttons').style.display = 'none';
                    document.getElementById('thermometerContainer').style.display = 'none';
                    document.querySelector('.feelings-scale').style.display = 'none';
                    
                    // Show modal
                    document.getElementById('feelingsOverlay').style.display = 'flex';
                    
                    // Auto-hide after 3 seconds
                    setTimeout(() => {
                        document.getElementById('feelingsOverlay').style.display = 'none';
                    }, 3000);
                    return;
                }
            } catch (error) {
                console.error('Error checking feelings status:', error);
            }
            
            // Reset modal to initial state
            document.querySelector('.feelings-modal h2').textContent = 'üå°Ô∏è Daily Check-In';
            document.querySelector('.feelings-modal p').textContent = 'How are you feeling today? Rate your overall mood on a scale of 0-10.';
            document.querySelector('.feelings-buttons').style.display = 'flex';
            document.getElementById('thermometerContainer').style.display = 'flex';
            document.querySelector('.feelings-scale').style.display = 'flex';
            
            // Reset submit button
            const submitButton = document.getElementById('submitFeeling');
            submitButton.disabled = true;
            submitButton.textContent = 'Submit';
            
            // Clear selection
            selectedFeeling = null;
            document.querySelectorAll('.thermometer-number').forEach(num => {
                num.classList.remove('selected');
            });
            
            // Show the modal
            document.getElementById('feelingsOverlay').style.display = 'flex';
        }

        function skipFeelingsCheck() {
            localStorage.setItem('mindmitra_feelings_completed_' + userId, 'true');
            document.getElementById('feelingsOverlay').style.display = 'none';
            localStorage.setItem('mindmitra_feelings_skipped_' + new Date().toDateString(), 'true');
        }

        function openChecklistModal() {
            loadChecklistState();
            loadChecklistComparison();
            document.getElementById('checklistModal').classList.add('active');
        }

        function closeChecklistModal() {
            document.getElementById('checklistModal').classList.remove('active');
        }

        // Badge Functions
        function openBadgeModal() {
            loadBadgeData();
            document.getElementById('badgeModal').classList.add('active');
        }

        function closeBadgeModal() {
            document.getElementById('badgeModal').classList.remove('active');
        }

        async function loadBadgeData() {
            if (!userId) {
                console.log('No userId, skipping badge load');
                return;
            }

            try {
                const response = await fetch(`/api/badges/${userId}`);
                const data = await response.json();

                if (data.success && data.badge_data) {
                    renderBadge(data.badge_data);
                } else {
                    console.error('No badge data in response:', data);
                }
            } catch (error) {
                console.error('Error loading badge data:', error);
            }
        }

        function renderBadge(badgeData) {
            const totalDays = badgeData.total_messaging_days || 0;
            const targetDays = 15;
            const isEarned = totalDays >= targetDays;
            const progressPercent = Math.min((totalDays / targetDays) * 100, 100);

            // Update header button icon
            const headerIcon = document.getElementById('badgeHeaderIcon');
            if (headerIcon) {
                headerIcon.src = isEarned ? '/static/15_days_after.png' : '/static/15_days_before.png';
            }

            // Update modal image
            const modalImage = document.getElementById('badgeModalImage');
            if (modalImage) {
                modalImage.src = isEarned ? '/static/15_days_after.png' : '/static/15_days_before.png';
            }

            // Update progress section
            const progressSection = document.getElementById('badgeProgressSection');
            const earnedText = document.getElementById('badgeEarnedText');
            const daysCount = document.getElementById('badgeDaysCount');
            const progressFill = document.getElementById('badgeProgressFill');

            if (isEarned) {
                if (progressSection) progressSection.style.display = 'none';
                if (earnedText) earnedText.style.display = 'block';
            } else {
                if (progressSection) progressSection.style.display = 'block';
                if (earnedText) earnedText.style.display = 'none';
                if (daysCount) daysCount.textContent = totalDays;
                if (progressFill) progressFill.style.width = `${progressPercent}%`;
            }

            // Add earned class for styling
            const badgeProgress = document.getElementById('badgeProgressSection');
            if (badgeProgress) {
                if (isEarned) {
                    badgeProgress.classList.add('badge-earned');
                } else {
                    badgeProgress.classList.remove('badge-earned');
                }
            }
        }

        function toggleChecklistItem(itemId) {
            const item = document.querySelector(`.checklist-item[data-item="${itemId}"]`);
            if (!item) return;
            item.classList.toggle('completed');
            saveChecklistState();
            updateChecklistProgress();
        }

        async function saveChecklistState() {
            if (!userId) return;
            const today = new Date().toDateString();
            const checklistKey = `mindmitra_checklist_${userId}_${today}`;
            const completedItems = [];
            document.querySelectorAll('.checklist-item.completed').forEach(item => {
                completedItems.push(item.getAttribute('data-item'));
            });
            localStorage.setItem(checklistKey, JSON.stringify(completedItems));

            // Also save to database
            try {
                const response = await fetch('/api/checklist/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId,
                        completed_count: completedItems.length,
                        completed_items: completedItems.join(',')
                    })
                });
                const data = await response.json();
                if (data.success && data.comparison) {
                    updateComparisonDisplay(data.comparison);
                }
            } catch (error) {
                console.error('Error saving checklist to database:', error);
            }
        }

        function loadChecklistState() {
            if (!userId) return;
            const today = new Date().toDateString();
            const checklistKey = `mindmitra_checklist_${userId}_${today}`;
            document.querySelectorAll('.checklist-item').forEach(item => item.classList.remove('completed'));
            const savedState = localStorage.getItem(checklistKey);
            if (savedState) {
                const completedItems = JSON.parse(savedState);
                completedItems.forEach(itemId => {
                    const item = document.querySelector(`.checklist-item[data-item="${itemId}"]`);
                    if (item) item.classList.add('completed');
                });
            }
            updateChecklistProgress();
        }

        function updateChecklistProgress() {
            const totalItems = document.querySelectorAll('.checklist-item').length;
            const completedItems = document.querySelectorAll('.checklist-item.completed').length;
            const progressText = document.getElementById('checklistProgressText');
            const progressFill = document.getElementById('checklistProgressFill');
            if (progressText) progressText.textContent = `${completedItems} / ${totalItems} completed`;
            if (progressFill) progressFill.style.width = `${(completedItems / totalItems) * 100}%`;
            if (completedItems === totalItems && totalItems > 0 && progressText) {
                setTimeout(() => progressText.textContent = 'üéâ Amazing! All tasks completed!', 300);
            }
        }

        function updateComparisonDisplay(comparison) {
            const comparisonDiv = document.getElementById('checklistComparison');
            if (!comparisonDiv) return;

            if (!comparison.has_yesterday) {
                // No yesterday data - show encouraging message with today's count
                if (comparison.today > 0) {
                    comparisonDiv.innerHTML = `<p style="color:#60a5fa;font-size:0.9rem;">üåü ${comparison.today}/5 today! Come back tomorrow to see your progress.</p>`;
                } else {
                    comparisonDiv.innerHTML = '<p style="color:#94a3b8;font-size:0.9rem;">Check off tasks to start tracking your progress!</p>';
                }
                return;
            }

            const diff = comparison.difference;
            let emoji = '';
            let message = '';
            let todayColor = '#60a5fa';

            if (diff > 0) {
                emoji = 'üìà';
                message = `+${diff} more than yesterday!`;
                todayColor = '#22c55e';
            } else if (diff < 0) {
                emoji = 'üí™';
                message = `You've got this!`;
                todayColor = '#f59e0b';
            } else {
                emoji = '‚ú®';
                message = `Consistent! Keep it up!`;
                todayColor = '#60a5fa';
            }

            comparisonDiv.innerHTML = `
                <div style="margin-top:0.5rem;font-size:0.85rem;">
                    <div style="display:flex;align-items:center;gap:0.75rem;margin-bottom:0.5rem;">
                        <span style="color:#94a3b8;font-size:0.8rem;white-space:nowrap;">Yesterday: ${comparison.yesterday}/5</span>
                        <div style="flex:1;background:#334155;border-radius:6px;height:6px;overflow:hidden;">
                            <div style="background:#64748b;height:100%;width:${(comparison.yesterday/5)*100}%;transition:width 0.3s;"></div>
                        </div>
                    </div>
                    <p style="color:${todayColor};text-align:center;margin:0;">${emoji} ${message}</p>
                </div>
            `;
        }

        async function loadChecklistComparison() {
            if (!userId) return;
            try {
                const response = await fetch(`/api/checklist/comparison/${userId}`);
                const data = await response.json();
                if (data.comparison) {
                    updateComparisonDisplay(data.comparison);
                }
            } catch (error) {
                console.error('Error loading checklist comparison:', error);
            }
        }

        // Streak Functions
        async function loadStreakData() {
            if (!userId) {
                console.log('No userId, skipping streak load');
                return;
            }

            console.log('Loading streak data for user:', userId);

            try {
                const response = await fetch(`/api/streak/${userId}`);
                const data = await response.json();
                
                console.log('Streak API Response:', data);

                if (data.success && data.streak_data) {
                    console.log('Rendering streak with data:', data.streak_data);
                    renderStreak(data.streak_data);
                } else {
                    console.error('No streak data in response:', data);
                }
            } catch (error) {
                console.error('Error loading streak data:', error);
            }
        }

        function renderStreak(streakData) {
            const streakCount = document.getElementById('streakCount');
            const headerStreakCount = document.getElementById('headerStreakCount');
            const streakMessage = document.getElementById('streakMessage');

            // Update streak counts
            const currentStreak = streakData.current_streak || 0;
            streakCount.textContent = currentStreak;
            headerStreakCount.textContent = currentStreak;

            // Update streak message
            if (streakData.has_activity_today) {
                if (streakData.current_streak > 0) {
                    streakMessage.innerHTML = `üéâ Amazing! You've kept your streak going for <strong>${streakData.current_streak}</strong> day${streakData.current_streak !== 1 ? 's' : ''}!`;
                } else {
                    streakMessage.textContent = 'Great job staying connected today!';
                }
            } else {
                if (streakData.current_streak > 0) {
                    streakMessage.innerHTML = `üî• You're on a <strong>${streakData.current_streak}</strong> day streak! Send a message today to keep it going!`;
                } else {
                    streakMessage.textContent = 'Send a message today to start your streak!';
                }
            }

            // Render weekly calendar
            renderWeeklyCalendar(streakData.weekly_activity, streakData.frozen_days);

            // Show auto-freeze message if one was just applied
            const autoFreezeMsg = document.getElementById('autoFreezeMessage');
            if (autoFreezeMsg) {
                if (streakData.auto_freeze_applied) {
                    autoFreezeMsg.innerHTML = '‚ùÑÔ∏è Auto-freeze saved your streak yesterday!';
                    autoFreezeMsg.style.display = 'block';
                } else {
                    autoFreezeMsg.style.display = 'none';
                }
            }
        }

        function renderWeeklyCalendar(weeklyActivity, frozenDays) {
            const calendar = document.getElementById('weeklyCalendar');
            calendar.innerHTML = '';

            const days = ['Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa', 'Su'];

            // Use IST timezone (same as backend) to determine "today"
            const today = getISTDate();
            const todayStr = formatDateLocal(today);
            
            // Get current week from Monday to Sunday
            const currentDay = today.getDay(); // 0 = Sunday, 1 = Monday, etc.
            const daysFromMonday = currentDay === 0 ? 6 : currentDay - 1; // Days since Monday
            
            // Calculate Monday of current week
            const monday = new Date(today);
            monday.setDate(today.getDate() - daysFromMonday);
            
            // Generate 7 days starting from Monday
            const dates = [];
            for (let i = 0; i < 7; i++) {
                const date = new Date(monday);
                date.setDate(monday.getDate() + i);
                dates.push(date);
            }

            console.log('Weekly Activity Data:', weeklyActivity);
            console.log('Frozen Days Data:', frozenDays);
            console.log('Today local date:', todayStr);
            
            dates.forEach((date, index) => {
                const dateStr = formatDateLocal(date);
                const dayOfWeek = days[index];
                const isToday = dateStr === todayStr;
                const hasActivity = weeklyActivity && weeklyActivity[dateStr] === true;
                const isFrozen = frozenDays && frozenDays[dateStr] === true;
                const isFutureDate = date > today;
                const isPastDate = date < today;

                console.log(`Day ${dayOfWeek} (${dateStr}): isToday=${isToday}, hasActivity=${hasActivity}, isFrozen=${isFrozen}, isPast=${isPastDate}`);

                const dayDiv = document.createElement('div');
                dayDiv.className = 'calendar-day';
                
                const label = document.createElement('div');
                label.className = 'day-label';
                label.textContent = dayOfWeek;
                
                const circle = document.createElement('div');
                circle.className = 'day-circle';
                
                // Priority: frozen > active > missed (past + no activity) > inactive (future or today)
                if (isFrozen) {
                    circle.classList.add('frozen');
                } else if (hasActivity) {
                    circle.classList.add('active');
                } else if (isPastDate) {
                    // Past date with no activity = missed
                    circle.classList.add('missed');
                } else {
                    // Future date or today with no activity yet = inactive
                    circle.classList.add('inactive');
                }
                
                if (isToday) {
                    circle.classList.add('today');
                }
                
                dayDiv.appendChild(label);
                dayDiv.appendChild(circle);
                calendar.appendChild(dayDiv);
            });
        }

        // Helper function to get current date in IST (India Standard Time)
        function getISTDate() {
            const now = new Date();
            // Convert to IST (UTC+5:30)
            const istOffset = 5.5 * 60; // IST is UTC+5:30 in minutes
            const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
            const istTime = new Date(utc + (istOffset * 60000));
            return istTime;
        }

        // Helper function to format date as YYYY-MM-DD
        function formatDateLocal(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function openStreakModal() {
            document.getElementById('streakModal').classList.add('active');
        }

        function closeStreakModal() {
            document.getElementById('streakModal').classList.remove('active');
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('streakModal');
            if (event.target === modal) {
                closeStreakModal();
            }
        });

        // Toggle helplines sidebar for mobile
        function toggleHelplines() {
            const sidebar = document.getElementById('hotlinesSidebar');
            const overlay = document.getElementById('sidebarOverlay');

            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');

            // Prevent body scrolling when sidebar is open
            if (sidebar.classList.contains('active')) {
                document.body.style.overflow = 'hidden';
            } else {
                document.body.style.overflow = '';
            }
        }

        // Initialize feelings thermometer on page load
        initFeelingsThermometer();

        // Check authentication on page load
        checkAuth();

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('SW registered: ', registration);
                    })
                    .catch((registrationError) => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
    </script>
</body>
</html> 